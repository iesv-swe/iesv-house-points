<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>House Points Leaderboard - IESV</title>
<link rel="icon" type="image/x-icon" href="leaderboard-favicon.ico">

<style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background:url('stone.png') repeat;
        background-size:600px;
        min-height:100vh;
        display:flex;
        flex-direction:column;
        padding:20px;
        color:white;
        overflow:hidden;
        position:relative;
    }

    /* Particle embers (global background) */
    .particles {
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        pointer-events:none;
        z-index:0;
    }

    .particle {
        position:absolute;
        width:4px; height:4px;
        background:rgba(255,140,0,0.85);
        border-radius:50%;
        animation:float 8s infinite ease-in-out;
    }

    @keyframes float {
        0% { transform:translateY(0); opacity:0; }
        10% { opacity:1; }
        100% { transform:translateY(-120vh); opacity:0; }
    }

    /* Header */
    .header {
        display:flex;
        align-items:center;
        gap:20px;
        margin-bottom:18px;
        position:relative;
        z-index:5;
        text-shadow:0 4px 12px black;
    }

    .logo {
        width:78px;
        filter:brightness(0) invert(1);
    }

    h1 {
        font-size:38px;
        font-weight:800;
        margin-bottom:2px;
    }

    .subtitle {
        font-size:16px;
        opacity:0.9;
        margin-top:-4px;
    }

    /* Leaderboard layout */
    .leaderboard {
        display:grid;
        grid-template-columns:repeat(2, 1fr);
        gap:18px;
        width:100%;
        height:calc(100vh - 160px);
        overflow:hidden;
        z-index:5;
    }

    /* House card */
    .house-card {
        background:rgba(0,0,0,0.55);
        border-radius:22px;
        padding:18px 22px;
        box-shadow:0 8px 28px rgba(0,0,0,0.65);
        border:2px solid rgba(255,255,255,0.06);
        backdrop-filter:blur(6px);
        display:flex;
        flex-direction:column;
        cursor:pointer;
        overflow:hidden;
        transition:0.3s ease;
        position:relative;
        z-index:1;
    }

    .house-card:hover {
        transform:translateY(-4px);
        box-shadow:0 14px 38px rgba(0,0,0,0.75);
    }

    /* WINNER CARD — continuous fiery glow */
    .house-card.winner {
        border:3px solid rgba(255,170,40,1);
        animation:winnerGlow 3.5s ease-in-out infinite;
        box-shadow:
            0 0 22px rgba(255,150,0,0.9),
            0 0 44px rgba(255,120,0,0.7),
            inset 0 0 18px rgba(255,120,0,0.4);
    }

    @keyframes winnerGlow {
        0% {
            box-shadow:
                0 0 22px rgba(255,150,0,0.9),
                0 0 44px rgba(255,120,0,0.7),
                inset 0 0 18px rgba(255,120,0,0.4);
            border-color:rgba(255,180,40,1);
        }
        50% {
            box-shadow:
                0 0 32px rgba(255,180,0,1),
                0 0 72px rgba(255,150,0,0.9),
                inset 0 0 28px rgba(255,140,0,0.6);
            border-color:rgba(255,210,60,1);
        }
        100% {
            box-shadow:
                0 0 22px rgba(255,150,0,0.9),
                0 0 44px rgba(255,120,0,0.7),
                inset 0 0 18px rgba(255,120,0,0.4);
            border-color:rgba(255,180,40,1);
        }
    }

    /* WINNER TRANSITION — subtle house-coloured pulse ring (plays once) */
    .house-card.winner-transition::before {
        content:"";
        position:absolute;
        inset:-10%;
        border-radius:28px;
        opacity:0;
        pointer-events:none;
        animation:winnerPulse 1.4s ease-out forwards;
        z-index:-1; /* behind card content, above background */
    }

    .house-card.winner-transition.winner-phoenix::before {
        background:radial-gradient(circle at center,
            rgba(255,90,30,0.0) 0%,
            rgba(255,90,30,0.35) 45%,
            rgba(255,90,30,0.0) 75%);
    }

    .house-card.winner-transition.winner-dragon::before {
        background:radial-gradient(circle at center,
            rgba(40,200,80,0.0) 0%,
            rgba(40,200,80,0.35) 45%,
            rgba(40,200,80,0.0) 75%);
    }

    .house-card.winner-transition.winner-hydra::before {
        background:radial-gradient(circle at center,
            rgba(60,150,255,0.0) 0%,
            rgba(60,150,255,0.35) 45%,
            rgba(60,150,255,0.0) 75%);
    }

    .house-card.winner-transition.winner-griffin::before {
        background:radial-gradient(circle at center,
            rgba(255,210,80,0.0) 0%,
            rgba(255,210,80,0.35) 45%,
            rgba(255,210,80,0.0) 75%);
    }

    @keyframes winnerPulse {
        0%   { transform:scale(0.6); opacity:0.0; }
        35%  { opacity:0.35; }
        100% { transform:scale(1.15); opacity:0.0; }
    }

    /* Internal floating embers (for winner card, always running) */
    @keyframes emberFloat {
        0%   { transform:translateY(0) scale(1); opacity:0.6; }
        50%  { transform:translateY(-14px) scale(1.4); opacity:1; }
        100% { transform:translateY(0) scale(1); opacity:0.6; }
    }

    /* Card header */
    .card-header {
        display:flex;
        align-items:center;
        height:80px;
        gap:16px;
        position:relative;
        z-index:2;
    }

    /* Carved stone medallion (B type) */
    .crest-wrap {
        width:90px;
        height:90px;
        border-radius:50%;
        background:url('stone-medallion-B.png') center/cover no-repeat;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:
            inset 0 0 14px rgba(0,0,0,0.9),
            inset 0 0 26px rgba(0,0,0,0.7);
    }

    .crest-wrap img {
        width:74%;
        opacity:0.95;
        filter:drop-shadow(0 2px 4px black);
    }

    .house-name {
        font-size:28px;
        font-weight:800;
        text-shadow:0 3px 10px black;
    }

    /* Rank badge */
    .rank-badge {
        margin-left:auto;
        width:54px;
        height:54px;
        border-radius:50%;
        background:rgba(255,255,255,0.12);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:18px;
        font-weight:700;
        border:2px solid rgba(255,255,255,0.18);
        position:relative;
        z-index:2;
    }

    .rank-badge.gold { background:linear-gradient(135deg,#ffd700,#ffae00); color:#000; }
    .rank-badge.silver { background:linear-gradient(135deg,#d4d4d4,#f7f7f7); color:#000; }
    .rank-badge.bronze { background:linear-gradient(135deg,#cd7f32,#e2a46e); color:#000; }

    /* Score area */
    .points-area {
        flex:1;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        text-align:center;
        position:relative;
        z-index:2;
    }

    .points-label {
        font-size:13px;
        text-transform:uppercase;
        letter-spacing:1px;
        color:#bbb;
        margin-bottom:6px;
    }

    /* MASSIVE score text */
    .points {
        font-size:clamp(80px, 14vw, 200px);
        font-weight:900;
        color:white;
        line-height:1;
        text-shadow:0 6px 22px rgba(0,0,0,0.9);
    }

    /* Winner number animation */
    .points.winner-points {
        color:#ffdd77;
        text-shadow:
            0 0 12px rgba(255,200,50,1),
            0 0 26px rgba(255,160,0,1),
            0 0 44px rgba(255,120,0,1),
            0 0 60px rgba(255,90,0,1);
        animation:winnerNumber 2.2s infinite ease-in-out;
    }

    @keyframes winnerNumber {
        0%,100% { opacity:1; transform:scale(1); }
        45% { opacity:0.92; transform:scale(1.03); }
        50% { opacity:1; transform:scale(1.05); }
        55% { opacity:0.93; transform:scale(1.02); }
    }

    /* Footer */
    .last-updated {
        text-align:center;
        opacity:0.85;
        font-size:12px;
        margin-top:4px;
    }
</style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="header">
    <img src="https://raw.githubusercontent.com/iesv-swe/IESV-Now-and-Next/main/logo.png" class="logo">
    <div>
        <h1>House Points Leaderboard</h1>
        <p class="subtitle">Live Rankings</p>
    </div>
</div>

<div class="leaderboard" id="leaderboard"></div>

<div class="last-updated" id="lastUpdated">Loading data...</div>

<script>
const API =
 "https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec?action=houseTotals";

const shields = {
    Phoenix: "phoenix2-removebg.png",
    Dragon:  "dragon2-removebg.png",
    Hydra:   "hydra2-removebg.png",
    Griffin: "griffin2-removebg.png"
};

function roundScore(n) { return Math.round(parseFloat(n)); }

let lastWinnerHouse = null;

async function loadLeaderboard() {
    try {
        const res = await fetch(API);
        const json = await res.json();
        if (json.status !== "success") throw new Error("Bad API");

        const houses = json.data.houses
            .slice()
            .sort((a,b) => a.rank - b.rank);

        renderLeaderboard(houses);

        document.getElementById("lastUpdated").textContent =
            "Last updated: " + new Date().toLocaleString();
    } catch (err) {
        document.getElementById("lastUpdated").textContent =
            "Error loading data.";
        console.error(err);
    }
}

function renderLeaderboard(houses) {
    const board = document.getElementById("leaderboard");
    board.innerHTML = "";

    const newWinnerHouse = houses.length ? houses[0].house : null;

    houses.forEach(x => {
        const rankClass =
            x.rank === 1 ? "gold" :
            x.rank === 2 ? "silver" :
            x.rank === 3 ? "bronze" : "";

        const isWinner = x.rank === 1;
        const winnerClass = isWinner ? "winner" : "";
        
        // Decide if we should play the transition pulse (only when winner changes)
        let transitionClass = "";
        if (isWinner && lastWinnerHouse && lastWinnerHouse !== newWinnerHouse) {
            const houseKey = x.house.toLowerCase(); // phoenix, dragon, hydra, griffin
            transitionClass = `winner-transition winner-${houseKey}`;
        }

        const card = document.createElement("div");
        card.className = `house-card ${winnerClass} ${transitionClass}`.trim();
        card.onclick = () =>
            window.location.href = `house-page.html?house=${x.house.toLowerCase()}`;

        card.innerHTML = `
            <div class="card-header">
                <div class="crest-wrap">
                    <img src="${shields[x.house]}">
                </div>
                <div class="house-name">${x.house}</div>
                <div class="rank-badge ${rankClass}">
                    ${x.rank}${x.rank === 1 ? "st" : x.rank === 2 ? "nd" : x.rank === 3 ? "rd" : "th"}
                </div>
            </div>

            <div class="points-area">
                <div class="points-label">House Score</div>
                <div class="points ${isWinner ? "winner-points" : ""}">
                    ${roundScore(x.houseScore)}
                </div>
            </div>
        `;

        // Always-on internal embers for the winner card
        if (isWinner) {
            for (let i = 0; i < 12; i++) {
                const ember = document.createElement("div");
                ember.style.position = "absolute";
                ember.style.width = "6px";
                ember.style.height = "6px";
                ember.style.borderRadius = "50%";
                ember.style.background = "rgba(255,140,0,0.9)";
                ember.style.left = Math.random()*90 + "%";
                ember.style.top = (60 + Math.random()*40) + "%";
                ember.style.filter = "blur(1px)";
                ember.style.animation = `emberFloat ${3 + Math.random()*3}s infinite ease-in-out`;
                card.appendChild(ember);
            }
        }

        board.appendChild(card);
    });

    // Update winner tracker AFTER render so transitions only fire on actual changes
    lastWinnerHouse = newWinnerHouse;
}

function createParticles() {
    const container = document.getElementById("particles");
    for (let i = 0; i < 28; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = Math.random()*100 + "%";
        p.style.animationDelay = (Math.random()*5) + "s";
        p.style.animationDuration = (7 + Math.random()*6) + "s";
        container.appendChild(p);
    }
}

createParticles();
loadLeaderboard();
setInterval(loadLeaderboard, 30000);
</script>

</body>
</html>
