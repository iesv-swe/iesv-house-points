<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>House Points - Teacher Input</title>
<link rel="icon" type="image/x-icon" href="../assets/icons/teacher-favicon.ico">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: url("../assets/images/backgrounds/stone.png") center/cover no-repeat fixed;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    color: white;
}

.container {
    width: 100%;
    max-width: 600px;
}

h1 {
    text-align: center;
    margin-bottom: 6px;
    font-size: 32px;
    letter-spacing: 1px;
    text-shadow: 0 0 8px black;
}

.subtitle {
    text-align: center;
    margin-bottom: 20px;
    font-size: 15px;
    opacity: 0.9;
    text-shadow: 0 0 8px black;
}

.card {
    background: rgba(60,60,60,0.92);
    color: white;
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 18px;
    box-shadow: 0 10px 35px rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
}

.card h2 {
    font-size: 19px;
    margin-bottom: 10px;
}

input {
    width: 100%;
    padding: 12px;
    margin-top: 6px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
}

/* ---- HOUSE 2√ó2 GRID ---- */
.house-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 8px;
}

.house-btn {
    position: relative;
    height: 180px;
    border-radius: 18px;
    background: #2b2b2b;
    border: none;
    cursor: pointer;
    overflow: hidden;
    padding: 0;
    transition: 0.25s ease;
    display: flex;
    justify-content: center;
    align-items: center;
}

.house-btn img {
    width: 85%;
    max-height: 140px;
    object-fit: contain;
    object-position: top;
    transform: translateY(-10px);
    pointer-events: none;
}

.house-btn:hover {
    box-shadow: 0 0 20px rgba(255,140,0,0.9);
    transform: scale(1.04);
}

.house-btn.selected {
    box-shadow: 0 0 28px rgba(255,140,0,1);
    transform: scale(1.06);
}

/* ---- CATEGORY BUTTONS ---- */
.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.category-btn {
    padding: 12px;
    border-radius: 12px;
    background: #555;
    color: white;
    cursor: pointer;
    transition: 0.15s;
    font-size: 15px;
}

.category-btn:hover {
    background: #777;
    transform: translateY(-1px);
}

.category-btn.selected {
    background: #00c3ff;
    color: black;
    font-weight: bold;
}

/* ---- SUBMIT BUTTON ---- */
#submitBtn {
    width: 100%;
    padding: 16px;
    background: #00c3ff;
    border: none;
    border-radius: 14px;
    font-size: 20px;
    color: black;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}

#submitBtn:hover {
    background: #41d9ff;
}

.footer-note {
    text-align: center;
    margin-top: 10px;
    font-size: 13px;
    opacity: 0.85;
    text-shadow: 0 0 8px black;
}

.status-message {
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    min-height: 20px;
}

.status-success { color: #7CFC7C; }
.status-error   { color: #ffb3b3; }

/* ---- STUDENT SELECTOR (NEW) ---- */

.student-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 10px;
    background: rgba(45,45,45,0.95);
    border: 1px solid rgba(255,255,255,0.12);
    cursor: pointer;
    font-size: 14px;
}

.student-toggle span.label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.student-toggle .chevron {
    font-size: 12px;
    opacity: 0.8;
}

.student-count-label {
    font-size: 11px;
    opacity: 0.8;
}

.student-panel {
    margin-top: 10px;
    border-radius: 10px;
    background: rgba(35,35,35,0.9);
    border: 1px solid rgba(255,255,255,0.12);
    padding: 10px;
}

.student-search-input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    margin-bottom: 6px;
}

.student-search-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0,195,255,0.4);
}

.student-suggestions {
    max-height: 180px;
    overflow-y: auto;
    border-radius: 8px;
    background: rgba(20,20,20,0.98);
    border: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 6px;
    display: none;
}

.student-suggestion {
    padding: 8px 10px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    font-size: 13px;
}

.student-suggestion:last-child {
    border-bottom: none;
}

.student-suggestion:hover {
    background: rgba(0,195,255,0.18);
}

.student-suggestion-main {
    font-weight: 600;
    color: #fff;
}

.student-suggestion-sub {
    font-size: 11px;
    color: #d1d5db;
}

.selected-students {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
}

.student-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    background: rgba(0,195,255,0.12);
    padding: 4px 8px;
    font-size: 12px;
}

.student-tag-name {
    font-weight: 500;
}

.student-tag-house {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.9;
}

.student-tag-remove {
    cursor: pointer;
    font-weight: 700;
    font-size: 12px;
}

.hidden {
    display: none !important;
}
</style>
</head>

<body>
<div class="container">
<h1>House Points</h1>
<p class="subtitle">Award 1 point for positive behaviour</p>

<!-- TEACHER INPUT -->
<div class="card">
    <h2>Your Name or Email</h2>
    <input id="teacherInput" type="text" placeholder="Enter your name or school email">
</div>

<!-- STUDENT SELECTOR (OPTIONAL, NEW) -->
<div class="card">
    <h2>Select Students (optional)</h2>
    <div id="studentToggle" class="student-toggle">
        <span class="label">
            <span id="studentToggleChevron" class="chevron">‚ñ∂</span>
            <span>Select students by name or email</span>
        </span>
        <span id="studentCountLabel" class="student-count-label"></span>
    </div>

    <div id="studentPanel" class="student-panel hidden">
        <input
            type="text"
            id="studentSearch"
            class="student-search-input"
            placeholder="Start typing a name or email‚Ä¶"
            autocomplete="off"
        >
        <div id="studentSuggestions" class="student-suggestions"></div>
        <div id="selectedStudents" class="selected-students"></div>
    </div>
</div>

<!-- HOUSE SELECTION -->
<div class="card" id="houseCard">
<h2>Select House</h2>
<div class="house-grid">

<button class="house-btn" data-house="Phoenix">
    <img src="../assets/images/houses/phoenix2-removebg.png" alt="Phoenix">
</button>

<button class="house-btn" data-house="Dragon">
    <img src="../assets/images/houses/dragon2-removebg.png" alt="Dragon">
</button>

<button class="house-btn" data-house="Hydra">
    <img src="../assets/images/houses/hydra2-removebg.png" alt="Hydra">
</button>

<button class="house-btn" data-house="Griffin">
    <img src="../assets/images/houses/griffin2-removebg.png" alt="Griffin">
</button>

</div>
</div>

<!-- CATEGORY SELECTION -->
<div class="card">
<h2>Select Category</h2>

<div class="category-grid">
<div class="category-btn" data-category="Kindness/Helping Others">‚ù§Ô∏è Kindness/Helping Others</div>
<div class="category-btn" data-category="Academic Effort/Excellence">üìö Academic Effort/Excellence</div>
<div class="category-btn" data-category="Teamwork/Collaboration">ü§ù Teamwork/Collaboration</div>
<div class="category-btn" data-category="Respect">üôè Respect</div>
<div class="category-btn" data-category="Leadership">‚≠ê Leadership</div>
<div class="category-btn" data-category="Creativity/Problem Solving">üí° Creativity/Problem Solving</div>
<div class="category-btn" data-category="Responsibility">‚úÖ Responsibility</div>
</div>
</div>

<!-- SUBMIT -->
<button id="submitBtn">Award 1 Point</button>

<p class="footer-note">multiple points can be awarded upon special request</p>
<div id="status" class="status-message"></div>

</div>

<script>
const APPS_SCRIPT_URL = 
"https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec";

let currentHouse = "";
let currentCategory = "";

// ---- NEW: student data ----
let allStudents = [];       // { name, email, house }
let selectedStudents = [];  // { name, email, house }

/* ---- HOUSE BUTTON LOGIC ---- */
const houseButtons = [...document.querySelectorAll(".house-btn")];
const houseCard = document.getElementById("houseCard");

houseButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        houseButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        currentHouse = btn.dataset.house;
    });
});

/* ---- CATEGORY BUTTON LOGIC ---- */
const categoryButtons = [...document.querySelectorAll(".category-btn")];
categoryButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        categoryButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        currentCategory = btn.dataset.category;
    });
});

/* ---- STATUS ---- */
function setStatus(msg, error = false) {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.classList.remove("status-success", "status-error");
    el.classList.add(error ? "status-error" : "status-success");
}

/* ---- STUDENT SELECTOR LOGIC (NEW) ---- */
const studentToggle = document.getElementById("studentToggle");
const studentToggleChevron = document.getElementById("studentToggleChevron");
const studentCountLabel = document.getElementById("studentCountLabel");
const studentPanel = document.getElementById("studentPanel");
const studentSearch = document.getElementById("studentSearch");
const studentSuggestions = document.getElementById("studentSuggestions");
const selectedStudentsContainer = document.getElementById("selectedStudents");

function toggleStudentPanel() {
    const hidden = studentPanel.classList.contains("hidden");
    if (hidden) {
        studentPanel.classList.remove("hidden");
        studentToggleChevron.textContent = "‚ñº";
        studentSearch.focus();
    } else {
        studentPanel.classList.add("hidden");
        studentToggleChevron.textContent = "‚ñ∂";
        studentSearch.value = "";
        hideSuggestions();
    }
}

studentToggle.addEventListener("click", toggleStudentPanel);

function renderSelectedStudents() {
    selectedStudentsContainer.innerHTML = "";

    if (selectedStudents.length === 0) {
        studentCountLabel.textContent = "";
        houseCard.classList.remove("hidden");
        return;
    }

    studentCountLabel.textContent = selectedStudents.length + " selected";

    // Hide houses when students are selected
    houseCard.classList.add("hidden");
    houseButtons.forEach(b => b.classList.remove("selected"));
    currentHouse = "";

    selectedStudents.forEach(student => {
        const tag = document.createElement("div");
        tag.className = "student-tag";

        const nameSpan = document.createElement("span");
        nameSpan.className = "student-tag-name";
        nameSpan.textContent = student.name;

        const houseSpan = document.createElement("span");
        houseSpan.className = "student-tag-house";
        houseSpan.textContent = student.house;

        const removeSpan = document.createElement("span");
        removeSpan.className = "student-tag-remove";
        removeSpan.textContent = "√ó";
        removeSpan.addEventListener("click", () => {
            selectedStudents = selectedStudents.filter(s => s.email !== student.email);
            renderSelectedStudents();
        });

        tag.appendChild(nameSpan);
        tag.appendChild(houseSpan);
        tag.appendChild(removeSpan);

        selectedStudentsContainer.appendChild(tag);
    });
}

function hideSuggestions() {
    studentSuggestions.style.display = "none";
    studentSuggestions.innerHTML = "";
}

function showSuggestions(list) {
    if (!list.length) {
        hideSuggestions();
        return;
    }

    studentSuggestions.innerHTML = "";
    list.forEach(student => {
        const div = document.createElement("div");
        div.className = "student-suggestion";

        const main = document.createElement("div");
        main.className = "student-suggestion-main";
        main.textContent = `${student.name} ‚Äî ${student.house}`;

        const sub = document.createElement("div");
        sub.className = "student-suggestion-sub";
        sub.textContent = student.email;

        div.appendChild(main);
        div.appendChild(sub);

        div.addEventListener("click", () => {
            const exists = selectedStudents.some(s => s.email === student.email);
            if (!exists) {
                selectedStudents.push(student);
                renderSelectedStudents();
            }
            studentSearch.value = "";
            hideSuggestions();
            studentSearch.focus();
        });

        studentSuggestions.appendChild(div);
    });

    studentSuggestions.style.display = "block";
}

function filterStudents(term) {
    const lower = term.toLowerCase();
    return allStudents.filter(s =>
        s.name.toLowerCase().includes(lower) ||
        s.email.toLowerCase().includes(lower)
    ).slice(0, 20);
}

studentSearch.addEventListener("input", () => {
    const term = studentSearch.value.trim();
    if (term.length < 2) {
        hideSuggestions();
        return;
    }
    const results = filterStudents(term);
    showSuggestions(results);
});

document.addEventListener("click", (e) => {
    if (!studentPanel.contains(e.target) && e.target !== studentToggle) {
        hideSuggestions();
    }
});

async function loadStudentList() {
    try {
        const url = APPS_SCRIPT_URL + "?action=listStudents";
        const res = await fetch(url);
        const data = await res.json();

        if (data.status === "success" && Array.isArray(data.students)) {
            allStudents = data.students.map(s => ({
                name: s.name || ((s.firstName || "") + " " + (s.lastName || "")).trim(),
                email: s.email,
                house: s.house || "Unknown"
            })).filter(s => s.email && s.name);
        } else {
            console.log("Unexpected student list response", data);
        }
    } catch (err) {
        console.error("Failed to load students", err);
    }
}

/* ---- SUBMIT ---- */
document.getElementById("submitBtn").addEventListener("click", async () => {

    const teacher = document.getElementById("teacherInput").value.trim();

    if (!teacher) return setStatus("Enter your name or email.", true);
    if (!currentCategory && selectedStudents.length === 0) {
        // category must be selected in both modes, but this branch ensures message order
    }
    if (!currentCategory) return setStatus("Select a category.", true);

    // MODE A: No students selected -> original behaviour
    if (selectedStudents.length === 0) {
        if (!currentHouse) return setStatus("Select a house.", true);

        const payload = {
            action: "points",
            source: "teacher-form",
            teacher,
            house: currentHouse,
            category: currentCategory,
            points: 1
        };

        setStatus("Submitting‚Ä¶");

        try {
            const res = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => null);

            if (!data || data.status === "error") {
                return setStatus("‚úó Error sending. Try again.", true);
            }

            setStatus("‚úì Point awarded!");

            houseButtons.forEach(b => b.classList.remove("selected"));
            categoryButtons.forEach(b => b.classList.remove("selected"));
            currentHouse = "";
            currentCategory = "";
        } catch (err) {
            console.error(err);
            return setStatus("‚úó Network error.", true);
        }

        return;
    }

    // MODE B: Students selected -> one row per student
    setStatus("Submitting for " + selectedStudents.length + " student(s)‚Ä¶");

    try {
        const requests = selectedStudents.map(student => {
            const payload = {
                action: "points",
                source: "teacher-form",
                teacher,
                house: student.house,
                category: currentCategory,
                points: 1,
                student: student.name
            };

            return fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(r => r.json().catch(() => null));
        });

        const results = await Promise.all(requests);
        const anyError = results.some(r => !r || r.status === "error");

        if (anyError) {
            setStatus("‚úó Some submissions failed. Please try again.", true);
        } else {
            setStatus("‚úì Points awarded for " + selectedStudents.length + " student(s).");
        }

        // Reset selections
        categoryButtons.forEach(b => b.classList.remove("selected"));
        currentCategory = "";

        selectedStudents = [];
        renderSelectedStudents();

        // Auto-collapse student panel
        if (!studentPanel.classList.contains("hidden")) {
            toggleStudentPanel();
        }

    } catch (err) {
        console.error(err);
        setStatus("‚úó Network error.", true);
    }
});

// ---- INIT ----
loadStudentList();
</script>

</body>
</html>
