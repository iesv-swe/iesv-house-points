<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
<title>House Points - Mobile</title>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-image: url("../assets/images/backgrounds/stone.png");
        background-size: cover;
        background-position: center;
        min-height: 100vh;
        padding: 10px;
        display: flex;
        justify-content: center;
    }

    .container {
        width: 100%;
        max-width: 480px;
    }

    /* --- CARD STYLING --- */
    .card {
        background: #3c3c3c;
        color: white;
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 14px;
        box-shadow: 0 0 14px rgba(0,0,0,0.55);
    }

    .card h2 {
        font-size: 17px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    /* --- INPUT FIELD --- */
    input[type="text"] {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-size: 16px;
    }

    /* --- HOUSE GRID --- */
    .house-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    /* Tighter shield tiles */
    .house-btn {
        background: #2f2f2f;
        border-radius: 12px;
        border: 2px solid transparent;
        padding: 6px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: 0.15s ease;
        height: 120px;     /* optimized for mobile */
    }

    .house-btn img {
        height: 90%;
        width: auto;
        object-fit: contain;
        pointer-events: none;
    }

    .house-btn.selected {
        border-color: white;
        box-shadow: 0 0 12px rgba(255,255,255,0.6);
        transform: scale(1.03);
    }

    /* --- CATEGORY GRID --- */
    .reason-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .reason-btn {
        padding: 10px;
        border-radius: 10px;
        background: #555;
        border: 2px solid transparent;
        font-size: 14px;
        color: white;
        text-align: left;
        cursor: pointer;
        transition: 0.15s ease;
    }

    .reason-btn.selected {
        background: #00a0df;
        color: black;
        border-color: white;
        font-weight: bold;
    }

    /* --- SUBMIT BUTTON --- */
    #submitBtn {
        width: 100%;
        padding: 16px;
        background: #00c3ff;
        border: none;
        border-radius: 12px;
        font-size: 20px;
        font-weight: bold;
        color: black;
        cursor: pointer;
        transition: 0.15s ease;
        margin-bottom: 6px;
    }

    #submitBtn:hover {
        background: #41d9ff;
    }

    .footer-note {
        text-align: center;
        font-size: 12px;
        opacity: 0.85;
        margin-bottom: 6px;
        color: white;
    }

    .status-message {
        text-align: center;
        min-height: 20px;
        font-size: 14px;
        color: #7CFC7C;
        text-shadow: 0 0 4px black;
    }

    .status-error {
        color: #ffb3b3;
    }

    /* --- STUDENT SELECTOR (NEW) --- */
    .student-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(45,45,45,0.95);
        border: 1px solid rgba(255,255,255,0.12);
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .student-toggle span.label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .student-toggle .chevron {
        font-size: 12px;
        opacity: 0.8;
    }

    .student-count-label {
        font-size: 11px;
        opacity: 0.8;
        color: #00c3ff;
        font-weight: 600;
    }

    .student-panel {
        margin-top: 4px;
        border-radius: 10px;
        background: rgba(35,35,35,0.9);
        border: 1px solid rgba(255,255,255,0.12);
        padding: 10px;
    }

    .student-search-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .student-search-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0,195,255,0.5);
    }

    .student-suggestions {
        max-height: 200px;
        overflow-y: auto;
        border-radius: 8px;
        background: rgba(20,20,20,0.98);
        border: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 8px;
        display: none;
    }

    .student-suggestion {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255,255,255,0.06);
        font-size: 13px;
    }

    .student-suggestion:last-child {
        border-bottom: none;
    }

    .student-suggestion:hover {
        background: rgba(0,195,255,0.2);
    }

    .student-suggestion-main {
        font-weight: 600;
        color: #fff;
        margin-bottom: 2px;
    }

    .student-suggestion-sub {
        font-size: 11px;
        color: #d1d5db;
    }

    .selected-students {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
    }

    .student-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        background: rgba(0,195,255,0.15);
        padding: 6px 10px;
        font-size: 12px;
    }

    .student-tag-name {
        font-weight: 600;
    }

    .student-tag-house {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.9;
    }

    .student-tag-remove {
        cursor: pointer;
        font-weight: 700;
        font-size: 14px;
        margin-left: 2px;
    }

    .hidden {
        display: none !important;
    }

</style>
</head>

<body>
<div class="container">

    <!-- NAME -->
    <div class="card">
        <h2>Your Name or Email</h2>
        <input id="teacherInput" type="text" placeholder="Enter your name or school email">
    </div>

    <!-- STUDENT SELECTOR (NEW) -->
    <div class="card">
        <h2>Select Students (optional)</h2>
        <div id="studentToggle" class="student-toggle">
            <span class="label">
                <span id="studentToggleChevron" class="chevron">‚ñ∂</span>
                <span>Search by name or email</span>
            </span>
            <span id="studentCountLabel" class="student-count-label"></span>
        </div>

        <div id="studentPanel" class="student-panel hidden">
            <input
                type="text"
                id="studentSearch"
                class="student-search-input"
                placeholder="Type name or email..."
                autocomplete="off"
            >
            <div id="studentSuggestions" class="student-suggestions"></div>
            <div id="selectedStudents" class="selected-students"></div>
        </div>
    </div>

    <!-- HOUSES -->
    <div class="card" id="houseCard">
        <h2>Select House</h2>
        <div class="house-grid">
            <button class="house-btn" data-house="Phoenix">
                <img src="../assets/images/houses/phoenix2-removebg.png">
            </button>
            <button class="house-btn" data-house="Dragon">
                <img src="../assets/images/houses/dragon2-removebg.png">
            </button>
            <button class="house-btn" data-house="Hydra">
                <img src="../assets/images/houses/hydra2-removebg.png">
            </button>
            <button class="house-btn" data-house="Griffin">
                <img src="../assets/images/houses/griffin2-removebg.png">
            </button>
        </div>
    </div>

    <!-- CATEGORIES -->
    <div class="card">
        <h2>Select Category</h2>
        <div class="reason-grid">
            <button class="reason-btn" data-reason="Kindness/Helping Others">‚ù§Ô∏è Kindness/Helping Others</button>
            <button class="reason-btn" data-reason="Academic Effort/Excellence">üìò Academic Effort/Excellence</button>
            <button class="reason-btn" data-reason="Teamwork/Collaboration">üíõ Teamwork/Collaboration</button>
            <button class="reason-btn" data-reason="Respect">üôè Respect</button>
            <button class="reason-btn" data-reason="Leadership">‚≠ê Leadership</button>
            <button class="reason-btn" data-reason="Creativity/Problem Solving">üé® Creativity/Problem Solving</button>
            <button class="reason-btn" data-reason="Responsibility">‚òëÔ∏è Responsibility</button>
        </div>
    </div>

    <!-- SUBMIT BUTTON -->
    <button id="submitBtn">Award 1 Point</button>

    <div class="footer-note">multiple points can be awarded upon special request</div>

    <div id="status" class="status-message"></div>

</div>


<script>
const APPS_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec";

let currentHouse = "";
let currentReason = "";

// NEW: student data
let allStudents = [];
let selectedStudents = [];

/* --- HOUSE SELECTION --- */
const houseButtons = document.querySelectorAll(".house-btn");
const houseCard = document.getElementById("houseCard");

houseButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        houseButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        currentHouse = btn.dataset.house;
    });
});

/* --- CATEGORY SELECTION --- */
document.querySelectorAll(".reason-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".reason-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        currentReason = btn.dataset.reason;
    });
});

function setStatus(text, error = false) {
    const el = document.getElementById("status");
    el.textContent = text;
    el.classList.toggle("status-error", error);
}

/* --- STUDENT SELECTOR LOGIC (NEW) --- */
const studentToggle = document.getElementById("studentToggle");
const studentToggleChevron = document.getElementById("studentToggleChevron");
const studentCountLabel = document.getElementById("studentCountLabel");
const studentPanel = document.getElementById("studentPanel");
const studentSearch = document.getElementById("studentSearch");
const studentSuggestions = document.getElementById("studentSuggestions");
const selectedStudentsContainer = document.getElementById("selectedStudents");

function toggleStudentPanel() {
    const hidden = studentPanel.classList.contains("hidden");
    if (hidden) {
        studentPanel.classList.remove("hidden");
        studentToggleChevron.textContent = "‚ñº";
        studentSearch.focus();
    } else {
        studentPanel.classList.add("hidden");
        studentToggleChevron.textContent = "‚ñ∂";
        studentSearch.value = "";
        hideSuggestions();
    }
}

studentToggle.addEventListener("click", toggleStudentPanel);

function renderSelectedStudents() {
    selectedStudentsContainer.innerHTML = "";

    if (selectedStudents.length === 0) {
        studentCountLabel.textContent = "";
        houseCard.classList.remove("hidden");
        return;
    }

    studentCountLabel.textContent = selectedStudents.length + " selected";

    // Hide house selector when students are selected
    houseCard.classList.add("hidden");
    houseButtons.forEach(b => b.classList.remove("selected"));
    currentHouse = "";

    selectedStudents.forEach(student => {
        const tag = document.createElement("div");
        tag.className = "student-tag";

        const nameSpan = document.createElement("span");
        nameSpan.className = "student-tag-name";
        nameSpan.textContent = student.name;

        const houseSpan = document.createElement("span");
        houseSpan.className = "student-tag-house";
        houseSpan.textContent = student.house;

        const removeSpan = document.createElement("span");
        removeSpan.className = "student-tag-remove";
        removeSpan.textContent = "√ó";
        removeSpan.addEventListener("click", () => {
            selectedStudents = selectedStudents.filter(s => s.email !== student.email);
            renderSelectedStudents();
        });

        tag.appendChild(nameSpan);
        tag.appendChild(houseSpan);
        tag.appendChild(removeSpan);

        selectedStudentsContainer.appendChild(tag);
    });
}

function hideSuggestions() {
    studentSuggestions.style.display = "none";
    studentSuggestions.innerHTML = "";
}

function showSuggestions(list) {
    if (!list.length) {
        hideSuggestions();
        return;
    }

    studentSuggestions.innerHTML = "";
    list.forEach(student => {
        const div = document.createElement("div");
        div.className = "student-suggestion";

        const main = document.createElement("div");
        main.className = "student-suggestion-main";
        main.textContent = `${student.name} ‚Äî ${student.house}`;

        const sub = document.createElement("div");
        sub.className = "student-suggestion-sub";
        sub.textContent = student.email;

        div.appendChild(main);
        div.appendChild(sub);

        div.addEventListener("click", () => {
            const exists = selectedStudents.some(s => s.email === student.email);
            if (!exists) {
                selectedStudents.push(student);
                renderSelectedStudents();
            }
            studentSearch.value = "";
            hideSuggestions();
            studentSearch.focus();
        });

        studentSuggestions.appendChild(div);
    });

    studentSuggestions.style.display = "block";
}

function filterStudents(term) {
    const lower = term.toLowerCase();
    return allStudents.filter(s =>
        s.name.toLowerCase().includes(lower) ||
        s.email.toLowerCase().includes(lower)
    ).slice(0, 20);
}

studentSearch.addEventListener("input", () => {
    const term = studentSearch.value.trim();
    if (term.length < 2) {
        hideSuggestions();
        return;
    }
    const results = filterStudents(term);
    showSuggestions(results);
});

document.addEventListener("click", (e) => {
    if (!studentPanel.contains(e.target) && e.target !== studentToggle) {
        hideSuggestions();
    }
});

async function loadStudentList() {
    try {
        const url = APPS_SCRIPT_URL + "?action=listStudents";
        const res = await fetch(url);
        const data = await res.json();

        if (data.status === "success" && Array.isArray(data.students)) {
            allStudents = data.students.map(s => ({
                name: s.name || ((s.firstName || "") + " " + (s.lastName || "")).trim(),
                email: s.email,
                house: s.house || "Unknown"
            })).filter(s => s.email && s.name);
        }
    } catch (err) {
        console.error("Failed to load students", err);
    }
}

/* --- SUBMIT --- */
document.getElementById("submitBtn").addEventListener("click", async () => {

    const teacher = document.getElementById("teacherInput").value.trim();

    if (!teacher) return setStatus("Please enter your name or email.", true);
    if (!currentReason) return setStatus("Please select a category.", true);

    // MODE A: No students selected -> award to house
    if (selectedStudents.length === 0) {
        if (!currentHouse) return setStatus("Please select a house.", true);

        const payload = {
            action: "points",
            teacher: teacher,
            student: "",
            house: currentHouse,
            category: currentReason,
            points: 1,
            timestamp: new Date().toISOString()
        };

        setStatus("Submitting‚Ä¶");

        try {
            const res = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.status !== "success") {
                return setStatus("Error submitting. Try again.", true);
            }

            setStatus("‚úì Point awarded!", false);

            document.querySelectorAll(".house-btn").forEach(b => b.classList.remove("selected"));
            document.querySelectorAll(".reason-btn").forEach(b => b.classList.remove("selected"));
            currentHouse = "";
            currentReason = "";
        } catch (err) {
            console.error(err);
            setStatus("Error submitting.", true);
        }

        return;
    }

    // MODE B: Students selected -> one point per student
    setStatus("Submitting for " + selectedStudents.length + " student(s)‚Ä¶");

    try {
        const requests = selectedStudents.map(student => {
            const payload = {
                action: "points",
                teacher: teacher,
                house: student.house,
                category: currentReason,
                points: 1,
                student: student.name,
                timestamp: new Date().toISOString()
            };

            return fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(r => r.json().catch(() => null));
        });

        const results = await Promise.all(requests);
        const anyError = results.some(r => !r || r.status === "error");

        if (anyError) {
            setStatus("‚úó Some submissions failed. Try again.", true);
        } else {
            setStatus("‚úì Points awarded for " + selectedStudents.length + " student(s).");
        }

        // Reset selections
        document.querySelectorAll(".reason-btn").forEach(b => b.classList.remove("selected"));
        currentReason = "";

        selectedStudents = [];
        renderSelectedStudents();

        // Auto-collapse student panel
        if (!studentPanel.classList.contains("hidden")) {
            toggleStudentPanel();
        }

    } catch (err) {
        console.error(err);
        setStatus("‚úó Network error.", true);
    }
});

// ---- INIT ----
loadStudentList();
</script>

</body>
</html>
