<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>House Swap - IESV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
<link rel="icon" type="image/x-icon" href="../assets/icons/console-favicon.ico">

<style>
    body {
        font-family: 'Segoe UI', Tahoma, sans-serif;
        background: linear-gradient(135deg, #102d69, #00a0df);
        min-height: 100vh;
        padding: 40px 20px;
        color: white;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .container {
        max-width: 650px;
        margin: auto;
        background: rgba(255,255,255,0.95);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        color: #102d69;
    }

    h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 36px;
        text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
    }

    label {
        font-weight: 600;
        margin-top: 10px;
        display: block;
    }

    input, select, textarea {
        width: 100%;
        padding: 12px;
        margin-top: 6px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    input:disabled {
        background: #eee;
    }

    textarea {
        resize: vertical;
        height: 80px;
    }

    .button {
        margin-top: 20px;
        width: 100%;
        padding: 16px;
        border-radius: 10px;
        background: linear-gradient(135deg, #ff4444, #ff8844);
        color: white;
        border: none;
        font-size: 18px;
        cursor: pointer;
        transition: transform .2s;
        font-weight: bold;
    }

    .button:hover {
        transform: translateY(-3px);
    }

    .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: bold;
        display: none;
    }

    .success { background: #d4edda; color: #155724; display: block; }
    .error { background: #f8d7da; color: #721c24; display: block; }

    .note {
        font-size: 13px;
        opacity: 0.7;
        margin-top: 4px;
    }

</style>
</head>
<body>

<h1>üè† House Swap Tool</h1>

<div class="container">

    <label for="staffEmail">Your Staff Email</label>
    <input type="email" id="staffEmail" placeholder="name.surname@engelska.se" required>

    <label for="password">Admin Password</label>
    <input type="password" id="password" placeholder="Enter admin password" required>

    <label for="studentSearch">Search Student</label>
    <input list="studentList" id="studentSearch" placeholder="Type a name or email...">
    <datalist id="studentList"></datalist>

    <label for="studentEmail">Student Email</label>
    <input type="email" id="studentEmail" disabled>

    <label for="currentHouse">Current House</label>
    <input type="text" id="currentHouse" disabled>

    <label for="newHouse">New House</label>
    <select id="newHouse">
        <option value="">Select House‚Ä¶</option>
        <option value="Phoenix">Phoenix üî•</option>
        <option value="Dragon">Dragon üêâ</option>
        <option value="Hydra">Hydra üåä</option>
        <option value="Griffin">Griffin ü¶Ö</option>
    </select>

    <label for="reason">Reason for Change</label>
    <textarea id="reason" placeholder="Optional but recommended"></textarea>

    <button class="button" onclick="submitSwap()">Swap House</button>

    <div id="status" class="status"></div>

</div>


<script>
// *** API URL ‚Äî YOUR LIVE ENDPOINT ***
const API = "https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec";

let students = [];

// --------------------- Load Student List ----------------------
async function loadStudents() {
    try {
        const res = await fetch(API + "?action=listStudents");
        const data = await res.json();

        if (data.status !== "success") return;

        students = data.students;

        const dl = document.getElementById("studentList");
        dl.innerHTML = "";

        students.forEach(s => {
            const option = document.createElement("option");
            option.value = `${s.name} (${s.email})`;
            dl.appendChild(option);
        });

    } catch (err) {
        console.error("Student list error:", err);
    }
}

loadStudents();


// -------------------- Autocomplete Selection --------------------
document.getElementById("studentSearch").addEventListener("change", () => {
    const input = document.getElementById("studentSearch").value;
    const match = students.find(s =>
        input.includes(s.email) || input.toLowerCase().includes(s.name.toLowerCase())
    );

    if (!match) return;

    document.getElementById("studentEmail").value = match.email;
    document.getElementById("currentHouse").value = match.house;
});


// ---------------------- Submit Swap ----------------------
async function submitSwap() {

    const staffEmail = document.getElementById("staffEmail").value.trim();
    const password = document.getElementById("password").value.trim();
    const studentEmail = document.getElementById("studentEmail").value.trim();
    const newHouse = document.getElementById("newHouse").value;
    const reason = document.getElementById("reason").value.trim();
    const statusBox = document.getElementById("status");

    statusBox.style.display = "none";

    if (!staffEmail || !password || !studentEmail || !newHouse) {
        statusBox.className = "status error";
        statusBox.innerText = "All required fields must be completed.";
        statusBox.style.display = "block";
        return;
    }

    try {
        const res = await fetch(API, {
            method: "POST",
            body: JSON.stringify({
                action: "swapHouse",
                staffEmail,
                password,
                email: studentEmail,
                newHouse,
                reason
            })
        });

        const data = await res.json();

        if (data.status === "success") {
            statusBox.className = "status success";
            statusBox.innerText = data.message;
            statusBox.style.display = "block";

            loadStudents(); // refresh house list
        } else {
            statusBox.className = "status error";
            statusBox.innerText = data.message;
            statusBox.style.display = "block";
        }

    } catch (err) {
        statusBox.className = "status error";
        statusBox.innerText = "Server communication error.";
        statusBox.style.display = "block";
        console.error(err);
    }
}
</script>

</body>
</html>
