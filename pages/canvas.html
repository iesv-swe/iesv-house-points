<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
<title>Canvas War - IESV House Points</title>
<link rel="icon" type="image/x-icon" href="../assets/icons/console-favicon.ico">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-image: url("../assets/images/backgrounds/stone.png");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    min-height: 100vh;
    padding: 20px;
    color: white;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    background: rgba(40, 40, 40, 0.95);
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
}

.header h1 {
    font-size: 42px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #dc143c, #228b22, #4169e1, #ff8c00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header .subtitle {
    font-size: 16px;
    opacity: 0.9;
    color: #b3bddc;
}

/* Email Screen */
.email-screen {
    max-width: 500px;
    margin: 0 auto;
    background: rgba(60, 60, 60, 0.95);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
}

.email-screen input {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    margin-bottom: 15px;
}

.btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #00c3ff, #0080ff);
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    transition: 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 195, 255, 0.4);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Main Canvas Layout */
.canvas-container {
    display: grid;
    grid-template-columns: 300px 1fr 300px;
    gap: 20px;
    align-items: start;
}

.sidebar {
    background: rgba(50, 50, 50, 0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.sidebar h3 {
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    color: #00c3ff;
}

/* Student Status */
.status-item {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
}

.status-label {
    font-size: 12px;
    text-transform: uppercase;
    opacity: 0.7;
    margin-bottom: 5px;
}

.status-value {
    font-size: 18px;
    font-weight: bold;
    color: #00c3ff;
}

.color-preview {
    width: 30px;
    height: 30px;
    border-radius: 5px;
    display: inline-block;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.countdown {
    font-size: 24px;
    font-weight: bold;
    color: #ff8c00;
    text-align: center;
    margin: 15px 0;
}

/* Canvas Grid */
.canvas-wrapper {
    background: rgba(40, 40, 40, 0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
}

#canvasGrid {
    /* Container for Mondrian blocks using absolute positioning */
    display: block;
    position: relative;
    background: rgba(100, 100, 100, 0.6);
    padding: 3px;
    margin: 0 auto;
    border-radius: 8px;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
}

/* Mondrian block styling */
.mondrian-block {
    position: absolute;
    background: #333;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 2px;
    border: 2px solid rgba(0, 0, 0, 0.7);
    box-sizing: border-box;
    box-shadow: inset 0 0 3px rgba(255, 255, 255, 0.1);
}

.mondrian-block:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
    z-index: 100;
    border: 3px solid rgba(255, 255, 255, 0.8);
}

.mondrian-block.claimed {
    cursor: default;
    border: 2px solid rgba(0, 0, 0, 0.8);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.15);
}

.mondrian-block.claimed:hover {
    transform: scale(1.02);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.2);
}

/* Territory Stats */
.territory-stats {
    margin-top: 20px;
}

.stat-bar {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.stat-house {
    width: 80px;
    font-weight: bold;
    font-size: 14px;
}

.stat-progress {
    flex: 1;
    height: 25px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
    overflow: hidden;
    margin: 0 10px;
    position: relative;
}

.stat-fill {
    height: 100%;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

.stat-count {
    width: 60px;
    text-align: right;
    font-size: 14px;
    opacity: 0.9;
}

/* Activity Feed */
.activity-feed {
    max-height: 300px;
    overflow-y: auto;
}

.activity-item {
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    font-size: 13px;
    border-left: 3px solid;
}

.activity-item .time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 3px;
}

/* Place Pixel Button */
.place-pixel-area {
    margin-top: 20px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    text-align: center;
}

.place-pixel-area .cooldown-msg {
    color: #ff6b6b;
    font-size: 14px;
    margin-top: 10px;
}

.place-pixel-area .ready-msg {
    color: #4caf50;
    font-size: 14px;
    margin-top: 10px;
}

/* Status Messages */
.status-message {
    padding: 12px;
    border-radius: 8px;
    margin-top: 10px;
    text-align: center;
    font-size: 13px;
}

.status-error {
    background: rgba(244, 67, 54, 0.2);
    border: 1px solid #f44336;
    color: #ffcdd2;
}

.status-success {
    background: rgba(76, 175, 80, 0.2);
    border: 1px solid #4caf50;
    color: #c8e6c9;
}

.status-info {
    background: rgba(33, 150, 243, 0.2);
    border: 1px solid #2196f3;
    color: #bbdefb;
}

/* Winner Banner */
.winner-banner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    background: linear-gradient(135deg, rgba(20, 20, 40, 0.98), rgba(30, 30, 50, 0.98));
    backdrop-filter: blur(15px);
    padding: 60px 80px;
    border-radius: 25px;
    border: 5px solid;
    box-shadow:
        0 0 100px rgba(0, 0, 0, 0.9),
        inset 0 0 50px rgba(255, 255, 255, 0.05);
    text-align: center;
    animation: bannerPulse 2s ease-in-out infinite;
}

.winner-banner.Phoenix { border-color: #dc143c; }
.winner-banner.Dragon { border-color: #228b22; }
.winner-banner.Hydra { border-color: #4169e1; }
.winner-banner.Griffin { border-color: #ff8c00; }

@keyframes bannerPulse {
    0%, 100% { box-shadow: 0 0 100px rgba(0, 0, 0, 0.9), inset 0 0 50px rgba(255, 255, 255, 0.05); }
    50% { box-shadow: 0 0 120px rgba(255, 215, 0, 0.5), inset 0 0 60px rgba(255, 255, 255, 0.1); }
}

.winner-banner h2 {
    font-size: 72px;
    font-weight: bold;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 8px;
    text-shadow: 0 0 30px currentColor;
    animation: winnerGlow 1.5s ease-in-out infinite;
}

.winner-banner.Phoenix h2 { color: #dc143c; }
.winner-banner.Dragon h2 { color: #228b22; }
.winner-banner.Hydra h2 { color: #4169e1; }
.winner-banner.Griffin h2 { color: #ff8c00; }

@keyframes winnerGlow {
    0%, 100% { text-shadow: 0 0 30px currentColor; }
    50% { text-shadow: 0 0 50px currentColor, 0 0 80px currentColor; }
}

.winner-banner .house-name {
    font-size: 96px;
    font-weight: 900;
    margin: 20px 0;
    text-transform: uppercase;
    letter-spacing: 12px;
}

.winner-banner .message {
    font-size: 32px;
    margin-top: 30px;
    opacity: 0.9;
    color: #ffffff;
    font-weight: 500;
}

.winner-banner .trophy {
    font-size: 120px;
    margin-bottom: 20px;
    animation: trophySpin 3s ease-in-out infinite;
}

@keyframes trophySpin {
    0%, 100% { transform: rotate(-5deg) scale(1); }
    50% { transform: rotate(5deg) scale(1.1); }
}

/* Previous Winners Card */
.previous-winners {
    background: rgba(50, 50, 50, 0.95);
    padding: 15px;
    border-radius: 12px;
    margin-top: 20px;
}

.previous-winners h4 {
    font-size: 14px;
    margin-bottom: 12px;
    color: #00c3ff;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.winner-item {
    padding: 8px 10px;
    margin-bottom: 6px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 3px solid;
}

.winner-item.Phoenix { border-color: #dc143c; }
.winner-item.Dragon { border-color: #228b22; }
.winner-item.Hydra { border-color: #4169e1; }
.winner-item.Griffin { border-color: #ff8c00; }

.winner-item .winner-house {
    font-weight: bold;
}

.winner-item .winner-date {
    opacity: 0.7;
    font-size: 10px;
}

.hidden {
    display: none !important;
}

.loading {
    text-align: center;
    padding: 40px;
}

.spinner {
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #00c3ff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 1200px) {
    .canvas-container {
        grid-template-columns: 1fr;
    }

    .sidebar {
        max-width: 600px;
        margin: 0 auto 20px;
    }

    .canvas-wrapper {
        padding: 15px;
    }
}

/* Mobile optimizations */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    .header h1 {
        font-size: 32px;
    }

    .header .subtitle {
        font-size: 14px;
    }

    .email-screen {
        padding: 30px 20px;
    }

    .canvas-wrapper {
        padding: 10px;
    }

    /* Canvas scales down on mobile */
    #canvasGrid {
        max-width: 100%;
        height: auto;
        aspect-ratio: 1;
    }

    .sidebar {
        padding: 15px;
    }

    .sidebar h3 {
        font-size: 16px;
    }

    .status-item {
        padding: 10px;
        margin-bottom: 12px;
    }

    .territory-stats h3 {
        font-size: 16px;
    }

    .winner-banner {
        padding: 40px 30px;
        max-width: 90%;
    }

    .winner-banner h2 {
        font-size: 48px;
        letter-spacing: 4px;
    }

    .winner-banner .house-name {
        font-size: 64px;
        letter-spacing: 8px;
    }

    .winner-banner .message {
        font-size: 24px;
    }

    .winner-banner .trophy {
        font-size: 80px;
    }
}

@media (max-width: 480px) {
    .header h1 {
        font-size: 28px;
    }

    .canvas-wrapper {
        padding: 8px;
    }

    .winner-banner {
        padding: 30px 20px;
    }

    .winner-banner h2 {
        font-size: 36px;
    }

    .winner-banner .house-name {
        font-size: 48px;
    }

    .winner-banner .message {
        font-size: 18px;
    }
}

/* Scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: rgba(0, 195, 255, 0.5);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 195, 255, 0.8);
}

/* Block placement animation */
@keyframes blockPlaced {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 rgba(255, 255, 255, 0);
    }
    50% {
        transform: scale(1.2);
        box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }
}

/* How to Play section */
.how-to-play {
    background: rgba(0, 195, 255, 0.1);
    border: 2px solid rgba(0, 195, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.how-to-play h3 {
    color: #00c3ff;
    font-size: 18px;
    margin-bottom: 15px;
    text-align: center;
}

.how-to-play-toggle {
    background: rgba(0, 195, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    margin-bottom: 15px;
}

.how-to-play-toggle:hover {
    background: rgba(0, 195, 255, 0.3);
    transform: translateY(-1px);
}

.how-to-play-content {
    line-height: 1.6;
}

.how-to-play-content ul {
    margin-left: 20px;
    margin-top: 10px;
}

.how-to-play-content li {
    margin-bottom: 8px;
}

.how-to-play-content strong {
    color: #00c3ff;
}
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>üé® House Canvas War</h1>
        <p class="subtitle">Claim territory for your house, one pixel at a time!</p>
    </div>

    <!-- WINNER BANNER (Hidden until winner declared) -->
    <div id="winnerBanner" class="winner-banner hidden">
        <div class="trophy">üèÜ</div>
        <h2>WINNER</h2>
        <div class="house-name" id="winnerHouseName"></div>
        <div class="message">Come Back Tomorrow to Play Again</div>
    </div>

    <!-- EMAIL INPUT SCREEN -->
    <div id="emailScreen" class="email-screen">
        <!-- How to Play Section -->
        <div class="how-to-play">
            <button class="how-to-play-toggle" onclick="this.nextElementSibling.classList.toggle('hidden')">
                üìñ How to Play Canvas War ‚ñº
            </button>
            <div class="how-to-play-content">
                <p><strong>üé® Claim territory for your house by placing colored blocks!</strong></p>
                <ul>
                    <li><strong>Cost:</strong> 1 house point per block</li>
                    <li><strong>Cooldown:</strong> 1 block per hour</li>
                    <li><strong>Strategy:</strong> First to claim wins - blocks are permanent!</li>
                    <li><strong>Goal:</strong> House with most blocks when campaign ends wins üèÜ</li>
                </ul>
                <p style="margin-top: 10px; font-size: 13px; opacity: 0.8;">
                    üí° Tip: Coordinate with your housemates to claim strategic areas!
                </p>
            </div>
        </div>

        <p style="margin-bottom: 15px; opacity: 0.9;">Enter your school email to join the canvas war:</p>
        <input
            type="email"
            id="emailInput"
            placeholder="your.name.student@engelska.se"
            autocomplete="email"
        >
        <button id="startBtn" class="btn-primary">Enter Canvas</button>

        <div id="emailStatus" class="status-message hidden"></div>
    </div>

    <!-- MAIN CANVAS SCREEN -->
    <div id="canvasScreen" class="hidden">
        <div class="canvas-container">
            <!-- LEFT SIDEBAR: Student Status -->
            <div class="sidebar">
                <h3>Your Status</h3>

                <div class="status-item">
                    <div class="status-label">Student</div>
                    <div class="status-value" id="studentName">-</div>
                </div>

                <div class="status-item">
                    <div class="status-label">House</div>
                    <div class="status-value" id="studentHouse">-</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Your Color</div>
                    <div>
                        <span class="color-preview" id="studentColor"></span>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">Available Points</div>
                    <div class="status-value" id="studentPoints">0</div>
                </div>

                <div id="countdownBox" class="status-item hidden">
                    <div class="status-label">Campaign Ends In</div>
                    <div class="countdown" id="campaignCountdown">-</div>
                </div>

                <div class="place-pixel-area">
                    <div id="cooldownStatus"></div>
                </div>
            </div>

            <!-- CENTER: Canvas Grid -->
            <div class="canvas-wrapper">
                <div id="canvasLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading canvas...</p>
                </div>

                <div id="canvasContent" class="hidden">
                    <div id="canvasGrid"></div>

                    <div class="territory-stats">
                        <h3 style="text-align: center; margin-bottom: 15px; color: #00c3ff;">Territory Control</h3>
                        <div class="stat-bar">
                            <div class="stat-house" style="color: #dc143c;">Phoenix</div>
                            <div class="stat-progress">
                                <div class="stat-fill" id="phoenixBar" style="background: #dc143c; width: 0%;">0%</div>
                            </div>
                            <div class="stat-count" id="phoenixCount">0</div>
                        </div>

                        <div class="stat-bar">
                            <div class="stat-house" style="color: #228b22;">Dragon</div>
                            <div class="stat-progress">
                                <div class="stat-fill" id="dragonBar" style="background: #228b22; width: 0%;">0%</div>
                            </div>
                            <div class="stat-count" id="dragonCount">0</div>
                        </div>

                        <div class="stat-bar">
                            <div class="stat-house" style="color: #4169e1;">Hydra</div>
                            <div class="stat-progress">
                                <div class="stat-fill" id="hydraBar" style="background: #4169e1; width: 0%;">0%</div>
                            </div>
                            <div class="stat-count" id="hydraCount">0</div>
                        </div>

                        <div class="stat-bar">
                            <div class="stat-house" style="color: #ff8c00;">Griffin</div>
                            <div class="stat-progress">
                                <div class="stat-fill" id="griffinBar" style="background: #ff8c00; width: 0%;">0%</div>
                            </div>
                            <div class="stat-count" id="griffinCount">0</div>
                        </div>

                        <div class="stat-bar">
                            <div class="stat-house" style="color: #000;">Teacher</div>
                            <div class="stat-progress">
                                <div class="stat-fill" id="staffBar" style="background: #000; width: 0%;">0%</div>
                            </div>
                            <div class="stat-count" id="staffCount">0</div>
                        </div>
                    </div>
                </div>

                <div id="canvasStatus" class="status-message hidden"></div>
            </div>

            <!-- RIGHT SIDEBAR: Recent Activity -->
            <div class="sidebar">
                <h3>Recent Activity</h3>
                <div class="activity-feed" id="activityFeed">
                    <p style="opacity: 0.6; text-align: center; padding: 20px;">No activity yet...</p>
                </div>

                <!-- Previous Winners -->
                <div class="previous-winners" id="previousWinners">
                    <h4>üèÜ Previous Winners</h4>
                    <div id="previousWinnersList">
                        <p style="opacity: 0.6; text-align: center; font-size: 11px;">No winners yet...</p>
                    </div>
                </div>

                <button id="refreshBtn" class="btn-primary" style="margin-top: 15px; font-size: 14px; padding: 12px;">
                    üîÑ Refresh Canvas
                </button>

                <button id="leaderboardBtn" class="btn-primary" style="margin-top: 10px; font-size: 14px; padding: 12px; background: linear-gradient(135deg, #9c27b0, #673ab7);">
                    üìä View Leaderboard
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec";

let studentEmail = '';
let studentStatus = null;
let canvasData = null;
let sessionId = generateSessionId();
let countdownInterval = null;
let mondrianLayout = null; // Will store layout from backend
let blockToGridMap = {}; // Maps block ID to grid (row, col)

function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Show status message
function showStatus(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = 'status-message status-' + type;
    el.classList.remove('hidden');
}

function hideStatus(elementId) {
    document.getElementById(elementId).classList.add('hidden');
}

// Enter canvas button
document.getElementById('startBtn').addEventListener('click', async () => {
    const email = document.getElementById('emailInput').value.trim().toLowerCase();

    if (!email || !email.includes('@')) {
        showStatus('emailStatus', 'Please enter a valid email address', 'error');
        return;
    }

    studentEmail = email;
    showStatus('emailStatus', 'Loading canvas...', 'info');
    document.getElementById('startBtn').disabled = true;

    // Load student status and canvas
    const success = await loadStudentStatus();

    if (success) {
        document.getElementById('emailScreen').classList.add('hidden');
        document.getElementById('canvasScreen').classList.remove('hidden');
        loadCanvas();
        loadRecentActivity();
        checkWinnerStatus();
        loadPreviousWinners();
        startCooldownCheck();
    } else {
        document.getElementById('startBtn').disabled = false;
    }
});

// Load student status
async function loadStudentStatus() {
    try {
        const url = `${API_URL}?action=getStudentCanvasStatus&email=${encodeURIComponent(studentEmail)}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success') {
            studentStatus = data;

            document.getElementById('studentName').textContent = data.name || 'Unknown';
            document.getElementById('studentHouse').textContent = data.isStaff ? 'Teacher' : data.house;
            document.getElementById('studentColor').style.background = data.color;
            document.getElementById('studentPoints').textContent = data.pointBalance;

            // Show countdown if enabled
            if (data.settings.campaignEndDate && studentStatus.settings) {
                const settingsResponse = await fetch(`${API_URL}?action=getCanvasSettings`);
                const settingsData = await settingsResponse.json();

                if (settingsData.status === 'success' && settingsData.settings.showCountdown) {
                    document.getElementById('countdownBox').classList.remove('hidden');
                    startCountdown(data.settings.campaignEndDate);
                }
            }

            updateCooldownStatus();
            return true;
        } else {
            showStatus('emailStatus', data.message || 'Error loading student status', 'error');
            return false;
        }
    } catch (error) {
        console.error('Canvas API Error:', error);
        let errorMsg = '‚ö†Ô∏è Connection Error\n\n';
        if (error.message.includes('Failed to fetch')) {
            errorMsg += 'Cannot reach the server. Please check:\n';
            errorMsg += '‚Ä¢ Your internet connection\n';
            errorMsg += '‚Ä¢ The API URL is correct\n';
            errorMsg += '‚Ä¢ Google Apps Script is deployed and running';
        } else {
            errorMsg += `Error: ${error.message}\n\n`;
            errorMsg += 'Troubleshooting:\n';
            errorMsg += '1. Verify Apps Script is deployed\n';
            errorMsg += '2. Run initializeCanvasSheets() in Apps Script\n';
            errorMsg += '3. Check browser console for details';
        }
        showStatus('emailStatus', errorMsg, 'error');
        return false;
    }
}

// Load canvas state
async function loadCanvas() {
    try {
        const url = `${API_URL}?action=getCanvasState`;
        console.log('üîÑ Loading canvas from:', url);
        const response = await fetch(url);
        const data = await response.json();

        console.log('üì¶ Canvas data received:', {
            status: data.status,
            pixelsCount: data.pixels ? data.pixels.length : 0,
            hasMondrianLayout: !!(data.settings && data.settings.mondrianLayout),
            mondrianBlockCount: data.settings && data.settings.mondrianLayout ? data.settings.mondrianLayout.length : 0
        });

        if (data.status === 'success') {
            canvasData = data;
            
            // Check if we got the Mondrian layout
            if (!data.settings || !data.settings.mondrianLayout || data.settings.mondrianLayout.length === 0) {
                console.error('‚ùå No Mondrian layout in response!');
                showStatus('canvasStatus', '‚ö†Ô∏è Canvas layout missing. Please contact admin to run initializeCanvasSheets() in Apps Script.', 'error');
                return;
            }
            
            renderCanvas(data);
            loadStats();
        } else {
            showStatus('canvasStatus', data.message || 'Error loading canvas', 'error');
        }
    } catch (error) {
        console.error('Canvas loading error:', error);
        showStatus('canvasStatus', '‚ö†Ô∏è Failed to load canvas. Check your internet connection and try refreshing the page.', 'error');
    }
}

// Render canvas grid
function renderCanvas(data) {
    const container = document.getElementById('canvasGrid');
    const { width, height } = data.settings;

    // Use Mondrian layout from backend (persistent across all users)
    // Always reload if backend provides a layout
    if (data.settings.mondrianLayout) {
        mondrianLayout = data.settings.mondrianLayout;
        // Build blockToGridMap from the layout
        blockToGridMap = {};
        mondrianLayout.forEach(block => {
            blockToGridMap[block.id] = { row: block.row, col: block.col };
        });
        console.log(`‚úÖ Loaded ${mondrianLayout.length} Mondrian blocks from backend`);
    }

    // Validation check
    if (!mondrianLayout || mondrianLayout.length === 0) {
        console.error('‚ùå ERROR: No Mondrian layout available!');
        showStatus('canvasStatus', '‚ö†Ô∏è Canvas layout not loaded. Please refresh or contact admin to run initializeCanvasSheets().', 'error');
        return;
    }

    // Create pixel map for quick lookup
    const pixelMap = {};
    data.pixels.forEach(pixel => {
        const key = `${pixel.row}-${pixel.col}`;
        pixelMap[key] = pixel;
    });

    // Clear container and set up as positioned container
    container.innerHTML = '';
    
    // Calculate responsive canvas size
    const maxCanvasSize = Math.min(600, window.innerWidth - 100);
    const canvasSize = window.innerWidth < 768 ? Math.min(maxCanvasSize, window.innerWidth - 40) : 600;
    
    container.style.width = canvasSize + 'px';
    container.style.height = canvasSize + 'px';
    container.style.margin = '0 auto';

    console.log(`üìê Rendering ${mondrianLayout.length} blocks at ${canvasSize}px size`);

    // Render each Mondrian block
    let renderedCount = 0;
    mondrianLayout.forEach(block => {
        // Validate block has required properties
        if (!block || block.x === undefined || block.y === undefined || 
            block.width === undefined || block.height === undefined) {
            console.warn('‚ö†Ô∏è Skipping invalid block:', block);
            return;
        }

        const blockDiv = document.createElement('div');
        blockDiv.className = 'mondrian-block';
        blockDiv.dataset.blockId = block.id;
        blockDiv.dataset.row = block.row;
        blockDiv.dataset.col = block.col;

        // Position and size based on block dimensions - scale to actual canvas size
        const scale = canvasSize / 1000; // Scale from 1000px virtual size to actual canvas size
        blockDiv.style.left = (block.x * scale) + 'px';
        blockDiv.style.top = (block.y * scale) + 'px';
        blockDiv.style.width = (block.width * scale) + 'px';
        blockDiv.style.height = (block.height * scale) + 'px';

        // Check if this block's grid position is claimed
        const key = `${block.row}-${block.col}`;
        if (pixelMap[key]) {
            blockDiv.style.background = pixelMap[key].color;
            blockDiv.classList.add('claimed');
            blockDiv.title = `${pixelMap[key].house} - ${new Date(pixelMap[key].placedAt).toLocaleString()}`;
        } else {
            blockDiv.style.background = '#333';
            blockDiv.title = 'Click to claim this block for your house!';
        }

        // Click handler - sends the mapped grid coordinate
        blockDiv.addEventListener('click', () => handlePixelClick(block.row, block.col));

        container.appendChild(blockDiv);
        renderedCount++;
    });

    console.log(`‚úÖ Successfully rendered ${renderedCount} blocks`);

    document.getElementById('canvasLoading').classList.add('hidden');
    document.getElementById('canvasContent').classList.remove('hidden');
}

// Handle pixel click
async function handlePixelClick(row, col) {
    if (!studentStatus || !studentStatus.canPlace) {
        if (studentStatus && studentStatus.pointBalance < 1) {
            showStatus('canvasStatus', 'You need at least 1 house point to place a block! Earn points first.', 'error');
        } else if (studentStatus && studentStatus.cooldown.onCooldown) {
            showStatus('canvasStatus', `Please wait ${studentStatus.cooldown.minutesRemaining} more minute(s) before placing another block.`, 'error');
        } else {
            showStatus('canvasStatus', 'Campaign is not active or you cannot place blocks.', 'error');
        }
        return;
    }

    // Get the block element
    const blockElement = document.querySelector(`.mondrian-block[data-row="${row}"][data-col="${col}"]`);
    if (!blockElement) {
        showStatus('canvasStatus', 'Error: Block not found. Please refresh the page.', 'error');
        return;
    }

    // Check if already claimed
    if (blockElement.classList.contains('claimed')) {
        showStatus('canvasStatus', 'This block has already been claimed!', 'error');
        return;
    }

    // Store original color for reverting if user cancels
    const originalColor = blockElement.style.background;
    const studentColor = studentStatus.color;
    const studentHouse = studentStatus.isStaff ? 'Teacher' : studentStatus.house;

    // INSTANT PREVIEW: Show the color immediately
    blockElement.style.background = studentColor;
    blockElement.style.transform = 'scale(1.1)';
    blockElement.style.boxShadow = '0 0 30px rgba(255, 255, 255, 0.8)';
    blockElement.style.border = '3px solid rgba(255, 255, 255, 0.9)';

    // Show confirmation dialog
    const confirmed = confirm(
        `üé® Claim this block for ${studentHouse}?\n\n` +
        `This will cost 1 house point.\n` +
        `You can place another block in 60 minutes.\n\n` +
        `Click OK to confirm or Cancel to choose a different block.`
    );

    // If user cancels, revert the preview
    if (!confirmed) {
        blockElement.style.background = originalColor;
        blockElement.style.transform = '';
        blockElement.style.boxShadow = '';
        blockElement.style.border = '2px solid rgba(0, 0, 0, 0.7)';
        showStatus('canvasStatus', 'Block selection cancelled. Choose another block!', 'info');
        return;
    }

    // User confirmed - proceed with placement
    hideStatus('canvasStatus');
    showStatus('canvasStatus', 'Claiming block...', 'info');

    // Keep the preview showing while we send to server
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'placePixel',
                email: studentEmail,
                row: row,
                col: col,
                sessionId: sessionId
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            showStatus('canvasStatus', 'üé® Block claimed successfully! You can place another in 60 minutes.', 'success');

            // Finalize the block styling (already showing correct color)
            blockElement.classList.add('claimed');
            blockElement.title = `${studentHouse} - Just placed!`;
            blockElement.style.transform = '';
            blockElement.style.border = '2px solid rgba(0, 0, 0, 0.8)';
            
            // Add celebratory animation
            blockElement.style.animation = 'blockPlaced 0.5s ease-out';
            setTimeout(() => {
                blockElement.style.animation = '';
                blockElement.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.5)';
            }, 500);

            // Update stats
            if (data.stats) {
                updateStats(data.stats);
            }

            // Reload student status
            await loadStudentStatus();
            loadRecentActivity();
            
            // Scroll to show the success message
            document.getElementById('canvasStatus').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        } else {
            // Server rejected - revert the preview
            blockElement.style.background = originalColor;
            blockElement.style.transform = '';
            blockElement.style.boxShadow = '';
            blockElement.style.border = '2px solid rgba(0, 0, 0, 0.7)';
            showStatus('canvasStatus', data.message || 'Failed to place block. Please try again.', 'error');
        }
    } catch (error) {
        // Network error - revert the preview
        blockElement.style.background = originalColor;
        blockElement.style.transform = '';
        blockElement.style.boxShadow = '';
        blockElement.style.border = '2px solid rgba(0, 0, 0, 0.7)';
        console.error('Canvas Error:', error);
        showStatus('canvasStatus', `‚ö†Ô∏è Network error: ${error.message}. Block not claimed. Please try again.`, 'error');
    }
}

// Load and update stats
async function loadStats() {
    try {
        const url = `${API_URL}?action=getCanvasStats`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success') {
            updateStats(data.stats);
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function updateStats(stats) {
    const houses = ['Phoenix', 'Dragon', 'Hydra', 'Griffin', 'Staff'];

    houses.forEach(house => {
        const houseData = stats[house];
        const barId = house.toLowerCase() + 'Bar';
        const countId = house.toLowerCase() + 'Count';

        const bar = document.getElementById(barId);
        const count = document.getElementById(countId);

        if (bar && count) {
            bar.style.width = houseData.percentage + '%';
            bar.textContent = houseData.percentage + '%';
            count.textContent = houseData.count;
        }
    });
}

// Load recent activity
async function loadRecentActivity() {
    try {
        const url = `${API_URL}?action=getCanvasRecentActivity&limit=10`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success' && data.activity.length > 0) {
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = '';

            data.activity.forEach(item => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.style.borderLeftColor = item.color;

                const time = new Date(item.timestamp);
                const timeAgo = getTimeAgo(time);
                
                // Display "Teacher" instead of "Staff" in activity feed
                const displayHouse = item.house === 'Staff' ? 'Teacher' : item.house;

                div.innerHTML = `
                    <div><strong>${displayHouse}</strong> placed a pixel at (${item.row}, ${item.col})</div>
                    <div class="time">${timeAgo}</div>
                `;

                feed.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Error loading activity:', error);
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return `${seconds}s ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

// Check for winner and display banner
async function checkWinnerStatus() {
    try {
        const url = `${API_URL}?action=getCanvasWinnerStatus`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success' && data.hasWinner) {
            const banner = document.getElementById('winnerBanner');
            const houseName = document.getElementById('winnerHouseName');

            houseName.textContent = data.winner.house.toUpperCase();
            banner.className = `winner-banner ${data.winner.house}`;
            banner.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error checking winner status:', error);
    }
}

// Load previous winners
async function loadPreviousWinners() {
    try {
        const url = `${API_URL}?action=getPreviousWinners`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success' && data.winners.length > 0) {
            const list = document.getElementById('previousWinnersList');
            list.innerHTML = '';

            data.winners.forEach(winner => {
                const div = document.createElement('div');
                div.className = `winner-item ${winner.house}`;

                const date = new Date(winner.date);
                const dateStr = date.toLocaleDateString();

                div.innerHTML = `
                    <div>
                        <div class="winner-house">${winner.house}</div>
                        <div class="winner-date">${dateStr}</div>
                    </div>
                    <div style="font-weight: bold; font-size: 14px;">${winner.percentage}%</div>
                `;

                list.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Error loading previous winners:', error);
    }
}

// Update cooldown status display
function updateCooldownStatus() {
    const statusDiv = document.getElementById('cooldownStatus');

    if (!studentStatus) {
        statusDiv.innerHTML = '<p class="cooldown-msg">Loading...</p>';
        return;
    }

    if (studentStatus.pointBalance < 1) {
        statusDiv.innerHTML = '<p class="cooldown-msg">‚ùå No points available<br>Earn points to play!</p>';
    } else if (studentStatus.cooldown.onCooldown) {
        statusDiv.innerHTML = `<p class="cooldown-msg">‚è≥ Cooldown: ${studentStatus.cooldown.minutesRemaining} min remaining</p>`;
    } else if (!studentStatus.settings.campaignActive) {
        statusDiv.innerHTML = '<p class="cooldown-msg">Campaign is not active</p>';
    } else {
        statusDiv.innerHTML = '<p class="ready-msg">‚úÖ Ready to place pixel!<br>Click on the canvas</p>';
    }
}

// Start cooldown check interval
function startCooldownCheck() {
    setInterval(async () => {
        await loadStudentStatus();
    }, 30000); // Check every 30 seconds
}

// Campaign countdown
function startCountdown(endDate) {
    const end = new Date(endDate);

    function update() {
        const now = new Date();
        const diff = end - now;

        if (diff <= 0) {
            document.getElementById('campaignCountdown').textContent = 'ENDED';
            clearInterval(countdownInterval);
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('campaignCountdown').textContent = `${days}d ${hours}h ${minutes}m`;
    }

    update();
    countdownInterval = setInterval(update, 60000); // Update every minute
}

// Refresh button
document.getElementById('refreshBtn').addEventListener('click', () => {
    loadCanvas();
    loadStats();
    loadRecentActivity();
    loadStudentStatus();
});

// Leaderboard button
document.getElementById('leaderboardBtn').addEventListener('click', () => {
    window.location.href = 'canvas-leaderboard.html';
});

// Enter key support
document.getElementById('emailInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('startBtn').click();
    }
});

// Handle window resize for responsive canvas
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        if (canvasData && mondrianLayout) {
            renderCanvas(canvasData);
        }
    }, 250);
});
</script>

</body>
</html>
