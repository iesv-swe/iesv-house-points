<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
<title>House Points Quiz - IESV</title>
<link rel="icon" type="image/x-icon" href="../assets/icons/console-favicon.ico">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-image: url("../assets/images/backgrounds/stone.png");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    min-height: 100vh;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.container {
    width: 100%;
    max-width: 700px;
}

.card {
    background: rgba(60, 60, 60, 0.95);
    color: white;
    padding: 30px;
    border-radius: 20px;
    margin-bottom: 20px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.header {
    text-align: center;
    margin-bottom: 10px;
}

.header h1 {
    font-size: 32px;
    margin-bottom: 8px;
    text-shadow: 0 0 10px rgba(0, 195, 255, 0.5);
}

.header .subtitle {
    font-size: 14px;
    opacity: 0.85;
    color: #b3bddc;
}

/* Email Input Screen */
.email-screen {
}

.email-screen input {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    margin-bottom: 15px;
}

.btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #00c3ff, #0080ff);
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    transition: 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 195, 255, 0.4);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Quiz Screen */
.quiz-screen {
}

.stats-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 11px;
    text-transform: uppercase;
    opacity: 0.7;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #00c3ff;
}

.timer {
    font-size: 32px !important;
}

.timer.warning {
    color: #ff6b6b;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.question-box {
    margin-bottom: 25px;
}

.question-number {
    font-size: 12px;
    text-transform: uppercase;
    color: #00c3ff;
    margin-bottom: 8px;
}

.question-text {
    font-size: 20px;
    line-height: 1.5;
    margin-bottom: 8px;
}

.question-category {
    font-size: 13px;
    opacity: 0.7;
    font-style: italic;
}

.answers-grid {
    display: grid;
    gap: 12px;
    margin-bottom: 20px;
}

.answer-btn {
    padding: 16px;
    background: rgba(45, 45, 45, 0.95);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: white;
    font-size: 16px;
    text-align: left;
    cursor: pointer;
    transition: 0.2s;
}

.answer-btn:hover:not(:disabled) {
    background: rgba(60, 60, 60, 0.95);
    border-color: #00c3ff;
    transform: translateX(5px);
}

.answer-btn:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.answer-btn.selected {
    background: rgba(0, 195, 255, 0.2);
    border-color: #00c3ff;
}

.answer-btn.correct {
    background: rgba(76, 175, 80, 0.3);
    border-color: #4caf50;
}

.answer-btn.incorrect {
    background: rgba(244, 67, 54, 0.3);
    border-color: #f44336;
}

.answer-label {
    display: inline-block;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(0, 195, 255, 0.2);
    color: #00c3ff;
    text-align: center;
    line-height: 28px;
    font-weight: bold;
    margin-right: 10px;
    font-size: 14px;
}

/* Result Screen */
.result-screen {
    text-align: center;
}

.result-icon {
    font-size: 80px;
    margin-bottom: 20px;
}

.result-title {
    font-size: 32px;
    margin-bottom: 10px;
}

.result-subtitle {
    font-size: 16px;
    opacity: 0.85;
    margin-bottom: 25px;
}

.result-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 25px;
}

.result-stat {
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
}

.result-stat-value {
    font-size: 36px;
    font-weight: bold;
    color: #00c3ff;
    margin-bottom: 5px;
}

.result-stat-label {
    font-size: 13px;
    opacity: 0.7;
    text-transform: uppercase;
}

.correct-answer-box {
    padding: 20px;
    background: rgba(76, 175, 80, 0.15);
    border: 2px solid #4caf50;
    border-radius: 12px;
    margin-bottom: 25px;
    text-align: left;
}

.correct-answer-box h3 {
    color: #4caf50;
    margin-bottom: 10px;
    font-size: 16px;
}

.btn-secondary {
    width: 100%;
    padding: 14px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 10px;
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
}

.status-message {
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    text-align: left;
    font-size: 14px;
    white-space: pre-line;
    line-height: 1.6;
}

.status-error {
    background: rgba(244, 67, 54, 0.2);
    border: 1px solid #f44336;
    color: #ffcdd2;
}

.status-success {
    background: rgba(76, 175, 80, 0.2);
    border: 1px solid #4caf50;
    color: #c8e6c9;
}

.status-info {
    background: rgba(33, 150, 243, 0.2);
    border: 1px solid #2196f3;
    color: #bbdefb;
}

.loading {
    text-align: center;
    padding: 40px;
    font-size: 18px;
}

.spinner {
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #00c3ff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.hidden {
    display: none !important;
}

@media (max-width: 600px) {
    .card {
        padding: 20px;
    }

    .header h1 {
        font-size: 24px;
    }

    .question-text {
        font-size: 18px;
    }

    .stats-bar {
        flex-direction: column;
        gap: 10px;
    }

    .result-stats {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>
<div class="container">
    <div class="card">
        <div class="header">
            <h1>üß† House Points Quiz</h1>
            <p class="subtitle">Test your knowledge, earn points for your house!</p>
        </div>

        <!-- EMAIL INPUT SCREEN -->
        <div id="emailScreen" class="email-screen">
            <p style="margin-bottom: 15px; opacity: 0.9;">Enter your school email to begin:</p>
            <input
                type="email"
                id="emailInput"
                placeholder="your.name.student@engelska.se"
                autocomplete="email"
            >
            <button id="startBtn" class="btn-primary">Start Quiz</button>

            <div id="emailStatus" class="status-message hidden"></div>
        </div>

        <!-- QUIZ SCREEN -->
        <div id="quizScreen" class="quiz-screen hidden">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-label">Time Left</div>
                    <div id="timerDisplay" class="stat-value timer">60</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Attempts Left</div>
                    <div id="attemptsLeft" class="stat-value">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Points Today</div>
                    <div id="pointsToday" class="stat-value">0</div>
                </div>
            </div>

            <div id="questionLoading" class="loading">
                <div class="spinner"></div>
                <p>Loading question...</p>
            </div>

            <div id="questionContent" class="hidden">
                <div class="question-box">
                    <div class="question-number" id="questionNumber">Question</div>
                    <div class="question-text" id="questionText"></div>
                    <div class="question-category" id="questionCategory"></div>
                </div>

                <div class="answers-grid" id="answersGrid"></div>

                <button id="submitBtn" class="btn-primary" disabled>Select an answer</button>

                <div id="quizStatus" class="status-message hidden"></div>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="resultScreen" class="result-screen hidden">
            <div class="result-icon" id="resultIcon"></div>
            <h2 class="result-title" id="resultTitle"></h2>
            <p class="result-subtitle" id="resultSubtitle"></p>

            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-value" id="timeTaken">-</div>
                    <div class="result-stat-label">Seconds</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="pointsEarned">-</div>
                    <div class="result-stat-label">Points Earned</div>
                </div>
            </div>

            <div id="correctAnswerBox" class="correct-answer-box hidden">
                <h3>‚úì Correct Answer:</h3>
                <p id="correctAnswerText"></p>
            </div>

            <button id="nextQuestionBtn" class="btn-primary">Next Question</button>
            <button id="quizLeaderboardBtn" class="btn-secondary" onclick="window.location.href='quiz-leaderboard.html'">üìä Quiz Leaderboard</button>
            <button id="finishBtn" class="btn-secondary">üèÜ House Standings</button>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec";

let studentEmail = '';
let currentQuestion = null;
let questionStartTime = null;
let timerInterval = null;
let selectedAnswer = null;
let sessionId = generateSessionId();

// Generate unique session ID
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Show/hide screens
function showScreen(screenName) {
    document.getElementById('emailScreen').classList.add('hidden');
    document.getElementById('quizScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.add('hidden');

    if (screenName === 'email') {
        document.getElementById('emailScreen').classList.remove('hidden');
    } else if (screenName === 'quiz') {
        document.getElementById('quizScreen').classList.remove('hidden');
    } else if (screenName === 'result') {
        document.getElementById('resultScreen').classList.remove('hidden');
    }
}

// Show status message
function showStatus(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = 'status-message status-' + type;
    el.classList.remove('hidden');
}

function hideStatus(elementId) {
    document.getElementById(elementId).classList.add('hidden');
}

// Start quiz button
document.getElementById('startBtn').addEventListener('click', async () => {
    const email = document.getElementById('emailInput').value.trim().toLowerCase();

    if (!email || !email.includes('@')) {
        showStatus('emailStatus', 'Please enter a valid email address', 'error');
        return;
    }

    // Allow any valid email for testing, but warn if not a student email
    if (!email.includes('engelska.se') && !email.includes('student')) {
        console.warn('Non-school email detected:', email);
    }

    studentEmail = email;
    showStatus('emailStatus', 'Checking eligibility...', 'info');
    document.getElementById('startBtn').disabled = true;

    // Check if student can take quiz
    const canTake = await checkEligibility();

    if (canTake.allowed) {
        showScreen('quiz');
        loadQuestion();
    } else {
        showStatus('emailStatus', canTake.message, 'error');
        document.getElementById('startBtn').disabled = false;
    }
});

// Check eligibility
async function checkEligibility() {
    try {
        const url = `${API_URL}?action=checkQuizEligibility&email=${encodeURIComponent(studentEmail)}`;
        console.log('Checking eligibility:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('Eligibility response:', data);

        if (data.status === 'success') {
            document.getElementById('attemptsLeft').textContent = data.attemptsRemaining;
            document.getElementById('pointsToday').textContent = data.pointsToday;
            return { allowed: true };
        } else {
            return { allowed: false, message: data.message || 'Unable to start quiz' };
        }
    } catch (error) {
        console.error('Eligibility check error:', error);
        return {
            allowed: false,
            message: 'Quiz system not yet configured. Please contact your administrator to set up the quiz backend (see QUIZ_SETUP_GUIDE.md).'
        };
    }
}

// Load question
async function loadQuestion() {
    document.getElementById('questionLoading').classList.remove('hidden');
    document.getElementById('questionContent').classList.add('hidden');
    hideStatus('quizStatus');
    selectedAnswer = null;

    try {
        const url = `${API_URL}?action=getQuizQuestion&email=${encodeURIComponent(studentEmail)}&sessionId=${sessionId}`;
        console.log('Loading question:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('Question response:', data);

        if (data.status === 'success' && data.question) {
            console.log('Question loaded successfully, displaying...');
            currentQuestion = data.question;
            questionStartTime = Date.now();

            try {
                displayQuestion(data.question);
                startTimer(data.timeLimit || 60);
                console.log('Question display and timer complete');
            } catch (error) {
                console.error('Error in displayQuestion or startTimer:', error);
                document.getElementById('questionLoading').classList.add('hidden');
                showStatus('quizStatus', 'Error displaying question: ' + error.message, 'error');
            }
        } else {
            // Show the error in the quiz screen
            document.getElementById('questionLoading').classList.add('hidden');

            const errorMsg = data.message || 'Failed to load question. Possible issues:\n' +
                '‚Ä¢ Quiz Questions sheet may not exist\n' +
                '‚Ä¢ No active questions in the sheet\n' +
                '‚Ä¢ Backend not fully configured\n\n' +
                'See QUIZ_SETUP_GUIDE.md for setup instructions.';

            showStatus('quizStatus', errorMsg, 'error');

            // Add a visible back button
            const backBtn = document.createElement('button');
            backBtn.className = 'btn-secondary';
            backBtn.textContent = '‚Üê Back to Start';
            backBtn.style.marginTop = '15px';
            backBtn.onclick = () => {
                showScreen('email');
                document.getElementById('startBtn').disabled = false;
                backBtn.remove();
            };
            document.getElementById('quizStatus').parentNode.appendChild(backBtn);
        }
    } catch (error) {
        console.error('Question load error:', error);
        document.getElementById('questionLoading').classList.add('hidden');
        showStatus('quizStatus', 'Network error or quiz backend not configured. Please see QUIZ_SETUP_GUIDE.md', 'error');

        // Add a visible back button
        const backBtn = document.createElement('button');
        backBtn.className = 'btn-secondary';
        backBtn.textContent = '‚Üê Back to Start';
        backBtn.style.marginTop = '15px';
        backBtn.onclick = () => {
            showScreen('email');
            document.getElementById('startBtn').disabled = false;
            backBtn.remove();
        };
        document.getElementById('quizStatus').parentNode.appendChild(backBtn);
    }
}

// Display question
function displayQuestion(question) {
    console.log('displayQuestion called with:', question);

    try {
        document.getElementById('questionLoading').classList.add('hidden');
        document.getElementById('questionContent').classList.remove('hidden');

        document.getElementById('questionNumber').textContent = `Question ID: ${question.id}`;
        document.getElementById('questionText').textContent = question.question;
        document.getElementById('questionCategory').textContent = `${question.category} ‚Ä¢ ${question.difficulty}`;

        const answersGrid = document.getElementById('answersGrid');
        answersGrid.innerHTML = '';

        console.log('Question content updated successfully');
    } catch (error) {
        console.error('Error displaying question:', error);
        throw error;
    }

    const options = [
        { label: 'A', text: question.optionA },
        { label: 'B', text: question.optionB },
        { label: 'C', text: question.optionC },
        { label: 'D', text: question.optionD }
    ];

    // Shuffle the options array to randomize answer order
    const shuffledOptions = shuffleArray(options);

    shuffledOptions.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.innerHTML = `<span class="answer-label">${option.label}</span>${option.text}`;
        btn.dataset.answer = option.label;

        btn.addEventListener('click', () => selectAnswer(option.label));

        answersGrid.appendChild(btn);
    });

    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').textContent = 'Select an answer';
}

// Shuffle array using Fisher-Yates algorithm
function shuffleArray(array) {
    const shuffled = [...array]; // Create a copy
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Select answer
function selectAnswer(answer) {
    if (!currentQuestion) return;

    selectedAnswer = answer;

    document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.answer === answer) {
            btn.classList.add('selected');
        }
    });

    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').textContent = 'Submit Answer';
}

// Timer
function startTimer(seconds) {
    console.log('startTimer called with:', seconds);
    clearInterval(timerInterval); // Clear any existing timer

    let timeLeft = seconds;
    document.getElementById('timerDisplay').textContent = timeLeft;
    document.getElementById('timerDisplay').classList.remove('warning');

    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timerDisplay').textContent = timeLeft;

        if (timeLeft <= 10) {
            document.getElementById('timerDisplay').classList.add('warning');
        }

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            submitAnswer(true); // Auto-submit on timeout
        }
    }, 1000);

    console.log('Timer started successfully');
}

// Submit answer
document.getElementById('submitBtn').addEventListener('click', () => submitAnswer(false));

async function submitAnswer(timeout = false) {
    clearInterval(timerInterval);

    document.getElementById('submitBtn').disabled = true;
    document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);

    if (timeout) {
        showStatus('quizStatus', 'Time\'s up!', 'error');
    }

    const timeTaken = Math.floor((Date.now() - questionStartTime) / 1000);

    const payload = {
        action: 'submitQuizAnswer',
        email: studentEmail,
        questionId: currentQuestion.id,
        answer: selectedAnswer || 'TIMEOUT',
        timeTaken: timeTaken,
        sessionId: sessionId
    };

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();

        if (data.status === 'success') {
            showResult(data);
        } else {
            showStatus('quizStatus', data.message || 'Submission failed', 'error');
        }
    } catch (error) {
        console.error('Quiz submission error:', error);
        showStatus('quizStatus', 'Network error. Please try again.', 'error');
    }
}

// Show result
function showResult(data) {
    showScreen('result');

    const isCorrect = data.isCorrect;

    document.getElementById('resultIcon').textContent = isCorrect ? 'üéâ' : 'üòï';
    document.getElementById('resultTitle').textContent = isCorrect ? 'Correct!' : 'Incorrect';
    document.getElementById('resultSubtitle').textContent = isCorrect
        ? 'Great job! You earned a point for your house.'
        : 'Don\'t worry, keep trying!';

    document.getElementById('timeTaken').textContent = data.timeTaken || '-';
    document.getElementById('pointsEarned').textContent = data.pointsAwarded || 0;

    // Show correct answer if wrong
    if (!isCorrect && data.correctAnswer) {
        document.getElementById('correctAnswerBox').classList.remove('hidden');
        document.getElementById('correctAnswerText').textContent = data.correctAnswer;
    } else {
        document.getElementById('correctAnswerBox').classList.add('hidden');
    }

    // Update stats
    if (data.attemptsRemaining !== undefined) {
        document.getElementById('attemptsLeft').textContent = data.attemptsRemaining;
    }
    if (data.pointsToday !== undefined) {
        document.getElementById('pointsToday').textContent = data.pointsToday;
    }

    // Show/hide next button based on attempts
    if (data.attemptsRemaining > 0) {
        document.getElementById('nextQuestionBtn').classList.remove('hidden');
    } else {
        document.getElementById('nextQuestionBtn').classList.add('hidden');
    }
}

// Next question
document.getElementById('nextQuestionBtn').addEventListener('click', () => {
    sessionId = generateSessionId(); // New session for new question
    showScreen('quiz');
    loadQuestion();
});

// Finish button
document.getElementById('finishBtn').addEventListener('click', () => {
    window.location.href = 'leaderboard.html';
});

// Enter key support for email
document.getElementById('emailInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('startBtn').click();
    }
});
</script>

</body>
</html>
