<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
<title>House Points Leaderboard - IESV</title>
<link rel="icon" type="image/x-icon" href="../assets/icons/leaderboard-favicon.ico">

<style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background:url('../assets/images/backgrounds/stone.png') repeat;
        background-size:600px;
        height:100vh;
        padding:clamp(8px, 1.5vh, 16px);
        color:white;
        display:flex;
        flex-direction:column;
        align-items:center;
        overflow:hidden;
    }

    /* Particles */
    .particles {
        position:fixed;
        inset:0;
        pointer-events:none;
        z-index:0;
    }

    .particle {
        position:absolute;
        width:4px; height:4px;
        background:rgba(255,140,0,0.85);
        border-radius:50%;
        animation:float 8s infinite ease-in-out;
    }

    @keyframes float {
        0% {transform:translateY(0);opacity:0;}
        10%{opacity:1;}
        100%{transform:translateY(-120vh);opacity:0;}
    }

    /* Header */
    .header {
        display:flex;
        align-items:center;
        gap:clamp(8px, 2vw, 20px);
        margin-bottom:clamp(8px, 1.5vh, 12px);
        text-align:center;
        z-index:5;
        width:100%;
        justify-content:center;
        text-shadow:0 4px 12px black;
        flex-shrink:0;
    }

    .logo {
        width:clamp(40px, 6vw, 70px);
    }

    h1 {
        font-size:clamp(22px, 3.5vw, 38px);
        font-weight:800;
        margin-bottom:2px;
        line-height:1.1;
    }

    .subtitle {
        font-size:clamp(11px, 1.5vw, 16px);
        opacity:0.9;
    }

    /* 2√ó2 grid - fully dynamic */
    .leaderboard {
        display:grid;
        grid-template-columns:repeat(2, 1fr);
        grid-template-rows:repeat(2, 1fr);
        gap:clamp(10px, 1.5vh, 20px);
        width:100%;
        max-width:1600px;
        flex:1;
        min-height:0;
        padding:0 clamp(8px, 2vw, 20px);
    }

    /* House card */
    .house-card {
        position:relative;
        background:rgba(0,0,0,0.55);
        border-radius:clamp(12px, 1.5vw, 20px);
        padding:clamp(10px, 1.5vh, 18px);
        box-shadow:0 8px 28px rgba(0,0,0,0.65);
        border:2px solid rgba(255,255,255,0.06);
        backdrop-filter:blur(6px);
        display:flex;
        flex-direction:column;
        transition:0.3s ease;
        z-index:1;
        min-height:0;
    }

    /* Winner glow */
    .house-card.winner {
        border:3px solid rgba(255,170,40,1);
        box-shadow:
            0 0 22px rgba(255,150,0,0.9),
            0 0 44px rgba(255,120,0,0.7),
            inset 0 0 18px rgba(255,120,0,0.4);
        animation:winnerGlow 3.5s ease-in-out infinite;
    }

    @keyframes winnerGlow {
        0% {
            box-shadow:
                0 0 22px rgba(255,150,0,0.9),
                0 0 44px rgba(255,120,0,0.7),
                inset 0 0 18px rgba(255,120,0,0.4);
        }
        50% {
            box-shadow:
                0 0 32px rgba(255,180,0,1),
                0 0 72px rgba(255,150,0,0.9),
                inset 0 0 28px rgba(255,140,0,0.6);
        }
        100% {
            box-shadow:
                0 0 22px rgba(255,150,0,0.9),
                0 0 44px rgba(255,120,0,0.7),
                inset 0 0 18px rgba(255,120,0,0.4);
        }
    }

    /* Card header ‚Äî centered house name, crest & badge spaced cleanly */
    .card-header {
        display:flex;
        align-items:center;
        justify-content:center;
        gap:clamp(8px, 1.5vw, 20px);
        margin-bottom:clamp(8px, 1.5vh, 14px);
        flex-shrink:0;
    }

    .crest-wrap {
        width:clamp(45px, 8vw, 80px);
        height:clamp(45px, 8vw, 80px);
        border-radius:50%;
        background: rgba(0,0,0,0.3);
        display:flex;
        align-items:center;
        justify-content:center;
        flex-shrink:0;
        box-shadow:
            inset 0 0 14px rgba(0,0,0,0.9),
            inset 0 0 26px rgba(0,0,0,0.7);
    }

    .crest-wrap img {
        width:75%;
        filter:drop-shadow(0 2px 4px black);
    }

    .house-name {
        font-size:clamp(18px, 2.5vw, 28px);
        font-weight:900;
        white-space:nowrap;
        text-align:center;
        flex-shrink:0;
    }

    .rank-badge {
        width:clamp(38px, 6vw, 60px);
        height:clamp(38px, 6vw, 60px);
        border-radius:50%;
        font-size:clamp(13px, 1.8vw, 22px);
        font-weight:700;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-shrink:0;
        border:2px solid rgba(255,255,255,0.18);
    }

    .gold   { background:linear-gradient(135deg,#ffd700,#ffae00); color:black; }
    .silver { background:linear-gradient(135deg,#d4d4d4,#f7f7f7); color:black; }
    .bronze { background:linear-gradient(135deg,#cd7f32,#e2a46e); color:black; }

    .points-area {
        flex:1;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
    }

    .points {
        font-size:clamp(40px, 10vw, 140px);
        font-weight:900;
        line-height:0.95;
        text-shadow:0 8px 26px rgba(0,0,0,0.9);
    }

    .points.winner-points {
        color:#ffdd77;
        text-shadow:
            0 0 12px rgba(255,200,50,1),
            0 0 26px rgba(255,160,0,1),
            0 0 44px rgba(255,120,0,1),
            0 0 60px rgba(255,90,0,1);
    }

    .quiz-points {
        font-size:clamp(8px, 1.5vw, 21px); /* Max 15% of 140px = 21px */
        opacity:0.75;
        margin-top:clamp(3px, 0.8vh, 8px);
        text-align:center;
    }

    .last-updated {
        font-size:clamp(9px, 1.2vw, 13px);
        opacity:0.85;
        margin-top:clamp(6px, 1vh, 10px);
        text-align:center;
        flex-shrink:0;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
        body {
            height:auto;
            min-height:100vh;
            overflow:auto;
        }

        .leaderboard {
            grid-template-columns: 1fr;
            grid-template-rows: auto;
            gap:clamp(15px, 3vw, 20px);
            flex:none;
        }
    }
</style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="header">
    <img src="../assets/images/logos/ies-logo.png" class="logo" alt="IESV Logo">
    <div>
        <h1>House Points Leaderboard</h1>
        <p class="subtitle">Live Rankings</p>
    </div>
</div>

<div class="leaderboard" id="leaderboard"></div>

<div class="last-updated" id="lastUpdated">Loading data...</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbyZkszKyoadMXT4fXahoNm3hqn6wj_pBscUjt0bt2gHOSnLaFyTJGEn9032liVRaqH3lQ/exec";
const API = API_BASE + "?action=houseTotals";

const shields = {
    Phoenix:"../assets/images/houses/phoenix2-removebg.png",
    Dragon :"../assets/images/houses/dragon2-removebg.png",
    Hydra  :"../assets/images/houses/hydra2-removebg.png",
    Griffin:"../assets/images/houses/griffin2-removebg.png"
};

function roundScore(n){ return Math.round(parseFloat(n)); }

async function loadLeaderboard() {
    try {
        const res = await fetch(API);
        
        const json = await res.json();
        if (json.status !== "success") throw new Error();

        // Fetch quiz points
        const quizRes = await fetch(API_BASE + "?action=getQuizPointsByHouse");
        
        const quizJson = await quizRes.json();
        const quizPoints = quizJson.status === "success" ? quizJson.houses : {};

        const houses = json.data.houses.slice().sort((a,b)=>a.rank-b.rank);
        renderLeaderboard(houses, quizPoints);

        document.getElementById("lastUpdated").textContent =
            "Last updated: " + new Date().toLocaleString();

    } catch(err) {
        console.error(err);
        const updatedEl = document.getElementById("lastUpdated");
        updatedEl.textContent = "‚ö†Ô∏è Error loading data.";
        updatedEl.style.color = "#ff9800";
        updatedEl.style.fontWeight = "bold";

        // Add retry button
        const board = document.getElementById("leaderboard");
        board.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üòï</div>
                <h2 style="color: #333; margin-bottom: 15px;">Failed to Load Leaderboard</h2>
                <p style="color: #666; margin-bottom: 25px;">
                    There was a problem connecting to the server.
                </p>
                <button onclick="location.reload()" style="
                    padding: 12px 30px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                    transition: transform 0.2s;
                ">
                    üîÑ Retry
                </button>
            </div>
        `;
    }
}

function renderLeaderboard(houses, quizPoints = {}){
    const board = document.getElementById("leaderboard");
    board.innerHTML = "";

    houses.forEach(h => {
        const ordinal = h.rank===1?"1st":h.rank===2?"2nd":h.rank===3?"3rd":"4th";
        const rankClass = h.rank===1?"gold":h.rank===2?"silver":h.rank===3?"bronze":"";
        const isWinner = h.rank===1;
        const houseQuizPoints = quizPoints[h.house] || 0;

        const card = document.createElement("div");
        card.className = "house-card" + (isWinner ? " winner" : "");

        card.innerHTML = `
            <div class="card-header">
                <div class="crest-wrap">
                    <img src="${shields[h.house]}" alt="${h.house}">
                </div>

                <div class="house-name">${h.house}</div>

                <div class="rank-badge ${rankClass}">
                    ${ordinal}
                </div>
            </div>

            <div class="points-area">
                <div class="points ${isWinner ? "winner-points" : ""}">
                    ${roundScore(h.houseScore)}
                </div>
                <div class="quiz-points">
                    Quiz Points: ${houseQuizPoints}
                </div>
            </div>
        `;

        board.appendChild(card);
    });
}

function createParticles(){
    const container = document.getElementById("particles");
    for(let i=0;i<28;i++){
        const p=document.createElement("div");
        p.className="particle";
        p.style.left=Math.random()*100+"%";
        p.style.animationDelay=(Math.random()*5)+"s";
        p.style.animationDuration=(7+Math.random()*6)+"s";
        container.appendChild(p);
    }
}

createParticles();
loadLeaderboard();
setInterval(loadLeaderboard,30000);
</script>

</body>
</html>
